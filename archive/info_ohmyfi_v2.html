<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Análisis Financiero Definitivo: Ohmyfi Venezuela</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .chart-container { position: relative; width: 100%; min-height: 350px; }
        .analysis-card { background-color: white; border-radius: 0.75rem; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04); padding: 1.5rem; display: flex; flex-direction: column; height: 100%; }
        .scenario-btn { cursor: pointer; padding: 0.5rem 1rem; border-radius: 0.375rem; transition: all 0.3s; font-weight: 500; }
        .scenario-btn.active { background-color: white; color: #004AAD; }
        .scenario-btn.inactive { background-color: transparent; color: white; }
        .analysis-text { margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e5e7eb; }
        .tooltip { position: relative; display: inline-block; cursor: pointer; }
        .tooltip .tooltiptext { visibility: hidden; width: 220px; background-color: #555; color: #fff; text-align: center; border-radius: 6px; padding: 5px; position: absolute; z-index: 1; bottom: 125%; left: 50%; margin-left: -110px; opacity: 0; transition: opacity 0.3s; font-weight: normal; font-size: 0.8rem; }
        .tooltip:hover .tooltiptext { visibility: visible; opacity: 1; }
        input[type=range] { -webkit-appearance: none; margin: 10px 0; width: 100%; }
        input[type=range]:focus { outline: none; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 8px; cursor: pointer; background: #06B6D4; border-radius: 5px; }
        input[type=range]::-webkit-slider-thumb { height: 20px; width: 20px; border-radius: 50%; background: #ffffff; cursor: pointer; -webkit-appearance: none; margin-top: -6px; }
        details > summary { list-style: none; }
        details > summary::-webkit-details-marker { display: none; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <main class="container mx-auto p-4 md:p-8">

        <header class="text-center mb-12">
            <h1 class="text-4xl md:text-5xl font-black text-gray-900 mb-2">Pronóstico Estratégico a 3 Años</h1>
            <p class="text-lg text-gray-600 max-w-3xl mx-auto">Análisis interactivo del impacto financiero y opciones de financiamiento de la solución AGT OhmyFi.</p>
        </header>

        <section id="calculator" class="bg-[#004AAD] text-white rounded-lg shadow-xl p-6 md:p-8 mb-12">
            <h2 class="text-3xl font-bold text-center mb-2">Simulador de Escenarios de Inversión</h2>
            <p class="text-center text-blue-100 mb-8 max-w-3xl mx-auto">Ajuste los parámetros para proyectar la rentabilidad según su modelo de negocio y financiamiento.</p>
            
            <div class="mb-6 flex justify-center">
                <div class="bg-black/20 p-1 rounded-lg flex space-x-1">
                    <button id="btnCompleta" class="scenario-btn active">Solución Completa (AGT)</button>
                    <button id="btnByod" class="scenario-btn inactive">Infraestructura Propia (BYOD)</button>
                </div>
            </div>

            <div id="financing-options" class="mb-6 px-4">
                <div class="flex justify-between items-center">
                   <h3 class="text-lg font-bold text-center mb-3">Plazo de Financiamiento</h3>
                   <span id="finance-term-label" class="font-bold text-lg">De Contado</span>
                </div>
                <input type="range" min="0" max="6" value="0" step="1" id="finance-slider" class="w-full">
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 items-start">
                <div id="infra-box" class="bg-white/10 p-6 rounded-lg">
                    <h3 class="text-xl font-bold mb-4">1. Defina Cantidad de APs</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div><label for="apStandard" class="block mb-1 text-sm font-medium">APs Interior Estándar</label><input type="number" id="apStandard" min="0" value="2" class="w-full p-2 rounded bg-gray-900/50 text-white border-2 border-transparent focus:border-[#06B6D4] focus-outline-none"></div>
                        <div><label for="apAdvanced" class="block mb-1 text-sm font-medium">APs Interior Avanzado</label><input type="number" id="apAdvanced" min="0" value="1" class="w-full p-2 rounded bg-gray-900/50 text-white border-2 border-transparent focus:border-[#06B6D4] focus-outline-none"></div>
                        <div><label for="apOutdoor" class="block mb-1 text-sm font-medium">APs Exterior</label><input type="number" id="apOutdoor" min="0" value="0" class="w-full p-2 rounded bg-gray-900/50 text-white border-2 border-transparent focus:border-[#06B6D4] focus-outline-none"></div>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white/10 p-6 rounded-lg">
                        <h3 class="text-xl font-bold mb-4 flex items-center">2. Ingrese su LTV 
                            <div class="tooltip ml-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-info-circle" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.064.293.006.399.287.47l.45.082.082-.38-.45-.083a.294.294 0 0 1-.288-.469l.738-3.468a.294.294 0 0 1 .288-.469zM8 4.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2z"/></svg>
                                <span class="tooltiptext">Valor de Vida del Cliente (LTV): Es el ingreso total que esperas que un cliente genere durante toda su relación con tu negocio.</span>
                            </div>
                        </h3>
                        <div><label for="ltv" class="block mb-1 text-sm font-medium">Valor (USD)</label><input type="number" id="ltv" min="0" value="50" step="10" class="w-full p-2 rounded bg-gray-900/50 text-white border-2 border-transparent focus:border-[#06B6D4] focus-outline-none"></div>
                    </div>
                    <div class="bg-white/10 p-6 rounded-lg"><h3 class="text-xl font-bold mb-4">3. Costo de Internet</h3><div><label for="internetCost" class="block mb-1 text-sm font-medium">Costo Mensual (USD)</label><input type="number" id="internetCost" min="0" value="60" step="5" class="w-full p-2 rounded bg-gray-900/50 text-white border-2 border-transparent focus:border-[#06B6D4] focus-outline-none"></div></div>
                </div>
            </div>
        </section>

        <section class="mb-12">
             <h2 class="text-3xl font-bold text-[#004AAD] mb-6 text-center">Análisis de Rentabilidad a 36 Meses</h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                 <div class="analysis-card"><div class="text-center"><h3 class="text-2xl font-bold text-gray-800 mb-2">Retorno de Inversión (ROI)</h3><p class="text-7xl font-black text-[#3B82F6] my-2" id="roi">0%</p><p class="text-gray-500">Resultado neto a 36 meses</p></div><div class="analysis-text"><h4 class="font-bold text-gray-700">Análisis y Conclusión</h4><p id="roiAnalysis" class="text-sm text-gray-600 mt-2">Ajuste los parámetros para calcular el ROI.</p></div></div>
                 <div class="analysis-card"><div class="text-center"><h3 class="text-2xl font-bold text-gray-800 mb-2">Período de Recuperación</h3><p class="text-7xl font-black text-gray-700 my-2" id="payback">N/A</p><p class="text-gray-500">Tiempo para cubrir la inversión inicial</p></div><div class="analysis-text"><h4 class="font-bold text-gray-700">Análisis y Conclusión</h4><p id="paybackAnalysis" class="text-sm text-gray-600 mt-2">Ajuste los parámetros para calcular el período de recuperación.</p></div></div>
            </div>
        </section>
        
        <section class="mb-12">
            <h2 class="text-3xl font-bold text-[#004AAD] mb-6 text-center">Análisis Detallado y Proyecciones</h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="analysis-card"><h3 class="text-xl font-bold text-gray-800 text-center">Evolución de Costos Mensuales</h3><div class="chart-container flex-grow"><canvas id="monthlyCostsChart"></canvas></div><div class="analysis-text"><h4 class="font-bold text-gray-700">Análisis y Conclusión</h4><p id="monthlyCostsAnalysis" class="text-sm text-gray-600 mt-2">Ajuste los parámetros para ver la evolución de costos.</p></div></div>
                <div class="analysis-card"><h3 class="text-xl font-bold text-gray-800 text-center">Camino a la Rentabilidad (Payback)</h3><div class="chart-container flex-grow"><canvas id="cumulativePaybackChart"></canvas></div><div class="analysis-text"><h4 class="font-bold text-gray-700">Análisis y Conclusión</h4><p id="cumulativePaybackAnalysis" class="text-sm text-gray-600 mt-2">Ajuste los parámetros para ver el camino a la rentabilidad.</p></div></div>
                <div class="analysis-card"><h3 class="text-xl font-bold text-gray-800 text-center">Costo Total de Propiedad (3 Años)</h3><div class="chart-container flex-grow"><canvas id="tcoChart"></canvas></div><div class="analysis-text"><h4 class="font-bold text-gray-700">Análisis y Conclusión</h4><p id="tcoAnalysis" class="text-sm text-gray-600 mt-2">Ajuste los parámetros para ver la distribución de costos.</p></div></div>
                <div class="analysis-card"><h3 class="text-xl font-bold text-gray-800 text-center">Simulación Monte Carlo del ROI</h3><div class="chart-container flex-grow"><canvas id="monteCarloChart"></canvas></div><div class="analysis-text"><h4 class="font-bold text-gray-700">Análisis y Conclusión</h4><p id="monteCarloAnalysis" class="text-sm text-gray-600 mt-2">Ajuste los parámetros para ejecutar el análisis de probabilidad.</p></div></div>
            </div>
        </section>

        <section class="bg-white rounded-lg shadow-lg p-6 md:p-8">
             <details>
                <summary class="flex justify-between items-center cursor-pointer">
                    <h2 class="text-2xl font-bold text-[#004AAD]">¿Qué significan estos términos?</h2>
                    <svg class="w-6 h-6 transform transition-transform" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                </summary>
                <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4 text-gray-700">
                    <div><h4 class="font-bold">ROI (Retorno de la Inversión)</h4><p class="text-sm">Mide la ganancia o pérdida neta de una inversión en relación con su costo total. Un ROI del 150% significa que por cada dólar invertido, ganaste 1.50 dólares netos.</p></div>
                    <div><h4 class="font-bold">TCO (Costo Total de Propiedad)</h4><p class="text-sm">Es la suma de todos los costos asociados a un activo durante su ciclo de vida: el costo inicial (hardware, instalación) más los costos operativos (licencias, internet).</p></div>
                    <div><h4 class="font-bold">Payback (Período de Recuperación)</h4><p class="text-sm">Es el tiempo exacto que tarda una inversión en generar suficientes flujos de caja netos para cubrir su costo inicial.</p></div>
                    <div><h4 class="font-bold">Flujo de Caja Neto</h4><p class="text-sm">Es la diferencia entre los ingresos y los gastos en un período determinado. Un flujo de caja positivo indica que entra más dinero del que sale.</p></div>
                    <div class="md:col-span-2"><h4 class="font-bold">Simulación Monte Carlo</h4><p class="text-sm">Es un análisis de riesgo que calcula miles de posibles resultados para una decisión. En lugar de un solo resultado, muestra una distribución de probabilidades, ayudando a entender cuál es el resultado más probable y cuál es el riesgo de pérdida.</p></div>
                </div>
            </details>
        </section>
    </main>

    <script>
        const ui = {
            btnCompleta: document.getElementById('btnCompleta'), btnByod: document.getElementById('btnByod'),
            financing: { el: document.getElementById('financing-options'), slider: document.getElementById('finance-slider'), label: document.getElementById('finance-term-label') },
            inputs: { std: document.getElementById('apStandard'), adv: document.getElementById('apAdvanced'), out: document.getElementById('apOutdoor'), ltv: document.getElementById('ltv'), internet: document.getElementById('internetCost') },
            outputs: { roi: document.getElementById('roi'), payback: document.getElementById('payback') },
            analysis: { roi: document.getElementById('roiAnalysis'), payback: document.getElementById('paybackAnalysis'), tco: document.getElementById('tcoAnalysis'), mc: document.getElementById('monteCarloAnalysis'), mcCosts: document.getElementById('monthlyCostsAnalysis'), cumPayback: document.getElementById('cumulativePaybackAnalysis') }
        };
        let charts = {};
        let currentScenario = 'completa';
        let currentFinanceTerm = 0;

        const PRICING = {
            ap_standard: 120, ap_advanced: 180, ap_outdoor: 250, controller: 250,
            auxiliaries_min: 400, auxiliaries_max: 800,
            installation_per_ap: 75, setup_fee_full: 150, setup_fee_byod: 250, 
            hardware_markup: 0.25,
            ohmyfi_license_per_ap: 16, zoho_crm_license: 50,
            financing: { 0: 0, 1: 0.15, 2: 0.20, 3: 0.25, 4: 0.30, 5: 0.32, 6: 0.35 }
        };
        const ROI_PARAMS = { 
            leads_per_ap_per_month: 25, leads_variation: 0.3,
            conversion_rate: 0.10, conversion_variation: 0.2
        };
        const PROJECTION_MONTHS = 36;

        function formatUSD(value) { return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(value); }

        function setScenario(scenario) {
            currentScenario = scenario;
            ui.financing.el.style.display = (scenario === 'completa') ? 'block' : 'none';
            ui.btnCompleta.classList.toggle('active', scenario === 'completa');
            ui.btnCompleta.classList.toggle('inactive', scenario !== 'completa');
            ui.btnByod.classList.toggle('active', scenario === 'byod');
            ui.btnByod.classList.toggle('inactive', scenario !== 'byod');
            calculate();
        }

        function updateFinanceTerm() {
            currentFinanceTerm = parseInt(ui.financing.slider.value);
            const term = currentFinanceTerm;
            ui.financing.label.textContent = term === 0 ? 'De Contado' : `${term} Mes${term > 1 ? 'es' : ''}`;
            calculate();
        }

        function initialize() {
            const tooltipOptions = { enabled: true, mode: 'index', intersect: false, callbacks: { label: (ctx) => `${ctx.dataset.label || ''}: ${formatUSD(ctx.parsed.y)}` } };
            const chartConfigs = [
                { id: 'tcoChart', type: 'doughnut', data: { labels: ['Hardware', 'Instalación', 'Licencias (3 Años)', 'Internet (3 Años)', 'Costo Financiero'], datasets: [{ data: [], backgroundColor: ['#003f5c', '#444e86', '#955196', '#dd5182', '#ff6e54'], borderColor: '#FFFFFF', borderWidth: 2 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { tooltip: { ...tooltipOptions, mode: 'point' }, legend: { position: 'bottom' } } } },
                { id: 'monthlyCostsChart', type: 'bar', data: { labels: Array.from({ length: PROJECTION_MONTHS }, (_, i) => `M${i+1}`), datasets: [{ label: 'Costo Mensual Total', data: [], backgroundColor: '#ff6e54' }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { callback: value => formatUSD(value) } } }, plugins: { tooltip: tooltipOptions } } },
                { id: 'cumulativePaybackChart', type: 'line', data: { labels: Array.from({ length: PROJECTION_MONTHS+1 }, (_, i) => `M${i}`), datasets: [{ label: 'Flujo de Caja Neto Acumulado', data: [], borderColor: '#444e86', backgroundColor: '#444e8640', fill: true, tension: 0.4 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { ticks: { callback: value => formatUSD(value) } } }, plugins: { tooltip: tooltipOptions } } },
                { id: 'monteCarloChart', type: 'bar', data: { labels: [], datasets: [{ label: 'Frecuencia', data: [], backgroundColor: [], borderWidth: 1 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { title: { display: true, text: 'Nº de Simulaciones (de 10000)' } }, x: { title: { display: true, text: 'Rango de ROI (%)' } } }, plugins: { tooltip: { ...tooltipOptions, mode: 'point' } } } }
            ];
            chartConfigs.forEach(c => charts[c.id] = new Chart(document.getElementById(c.id).getContext('2d'), c));
            
            Object.values(ui.inputs).forEach(input => input.addEventListener('input', calculate));
            ui.btnCompleta.addEventListener('click', () => setScenario('completa'));
            ui.btnByod.addEventListener('click', () => setScenario('byod'));
            ui.financing.slider.addEventListener('input', updateFinanceTerm);
            setScenario('completa');
        }
        
        function calculate() {
            const apCounts = { std: parseInt(ui.inputs.std.value) || 0, adv: parseInt(ui.inputs.adv.value) || 0, out: parseInt(ui.inputs.out.value) || 0 };
            const totalApCount = apCounts.std + apCounts.adv + apCounts.out;
            const customerLtv = parseFloat(ui.inputs.ltv.value) || 0;
            const internetCost = parseFloat(ui.inputs.internet.value) || 0;

            if (totalApCount === 0 || customerLtv === 0) { resetUI(); return; }

            const hardwareCost = (apCounts.std * PRICING.ap_standard) + (apCounts.adv * PRICING.ap_advanced) + (apCounts.out * PRICING.ap_outdoor) + PRICING.controller;
            const auxCost = PRICING.auxiliaries_min + (PRICING.auxiliaries_max - PRICING.auxiliaries_min) * Math.min(totalApCount / 20, 1);
            const physicalInstallCost = totalApCount * PRICING.installation_per_ap;

            let hardwareInvestment = 0, installationCost = 0;
            
            if (currentScenario === 'completa') {
                hardwareInvestment = hardwareCost * (1 + PRICING.hardware_markup);
                installationCost = physicalInstallCost + auxCost + PRICING.setup_fee_full;
            } else {
                hardwareInvestment = hardwareCost;
                installationCost = physicalInstallCost + auxCost + PRICING.setup_fee_byod;
            }
            
            const initialInvestment = hardwareInvestment + installationCost;
            const term = currentScenario === 'completa' ? currentFinanceTerm : 0;
            const financingRate = PRICING.financing[term];
            const financingCost = initialInvestment * financingRate;
            const totalFinancedAmount = initialInvestment + financingCost;
            const financingInstallment = term > 0 ? totalFinancedAmount / term : 0;
            const effectiveInitialOutlay = term > 0 ? 0 : initialInvestment;

            const monthlyLicenses = (totalApCount * PRICING.ohmyfi_license_per_ap) + PRICING.zoho_crm_license;
            const monthlyBenefit = totalApCount * ROI_PARAMS.leads_per_ap_per_month * ROI_PARAMS.conversion_rate * customerLtv;

            const monthlyCosts = Array.from({length: PROJECTION_MONTHS}, (_, i) => monthlyLicenses + internetCost + (i < term ? financingInstallment : 0));
            const netCashFlows = monthlyCosts.map(cost => monthlyBenefit - cost);
            
            const totalLicenses36 = monthlyLicenses * PROJECTION_MONTHS;
            const totalInternet36 = internetCost * PROJECTION_MONTHS;
            const tco36Months = initialInvestment + totalLicenses36 + totalInternet36 + financingCost;

            const totalBenefit36Months = monthlyBenefit * PROJECTION_MONTHS;
            const roi = tco36Months > 0 ? ((totalBenefit36Months - tco36Months) / tco36Months) * 100 : 0;
            
            let cumulativeCashFlow = -effectiveInitialOutlay;
            let paybackMonths = Infinity;
            const cumulativeFlows = [cumulativeCashFlow];
            for(let i=0; i < PROJECTION_MONTHS; i++) {
                cumulativeCashFlow += netCashFlows[i];
                cumulativeFlows.push(cumulativeCashFlow);
                if (cumulativeCashFlow >= 0 && paybackMonths === Infinity) paybackMonths = i + 1;
            }

            updateUIData({ roi, paybackMonths, initialInvestment, tco36Months, totalBenefit36Months, hardwareInvestment, installationCost, financingCost, monthlyCosts, cumulativeFlows, totalApCount, customerLtv, monthlyLicenses, internetCost });
        }

        function updateUIData(data) {
            ui.outputs.roi.textContent = `${data.roi.toFixed(0)}%`;
            ui.outputs.payback.textContent = data.paybackMonths === Infinity ? 'N/A' : `${data.paybackMonths} m`;

            ui.analysis.roi.innerHTML = data.roi > 0 ? `Se proyecta un retorno del <strong>${data.roi.toFixed(0)}%</strong> sobre la inversión total. Los beneficios generados superan significativamente los costos.` : `Bajo este escenario, el proyecto no alcanza la rentabilidad en 36 meses.`;
            ui.analysis.payback.innerHTML = data.paybackMonths !== Infinity && data.paybackMonths <= 36 ? `La inversión inicial de <strong>${formatUSD(data.initialInvestment)}</strong> se recupera en <strong>${data.paybackMonths} meses</strong>, marcando el inicio de la rentabilidad.` : `La inversión inicial no se recupera dentro del período de 36 meses.`;
            
            charts.tcoChart.data.datasets[0].data = [data.hardwareInvestment, data.installationCost, (data.monthlyLicenses*PROJECTION_MONTHS), (data.internetCost*PROJECTION_MONTHS), data.financingCost];
            charts.tcoChart.update();
            ui.analysis.tco.innerHTML = `El TCO a 3 años es de <strong>${formatUSD(data.tco36Months)}</strong>. El costo financiero del plazo elegido representa un <strong>${(data.financingCost/data.tco36Months*100).toFixed(0)}%</strong> de este total.`;
            
            charts.monthlyCostsChart.data.datasets[0].data = data.monthlyCosts;
            charts.monthlyCostsChart.update();
            ui.analysis.mcCosts.innerHTML = currentFinanceTerm > 0 ? `El costo mensual es mayor durante los primeros <strong>${currentFinanceTerm} meses</strong> debido al financiamiento, luego se estabiliza. Esto protege el flujo de caja inicial.` : `Con pago de contado, el costo mensual es estable desde el inicio.`;
            
            charts.cumulativePaybackChart.data.datasets[0].data = data.cumulativeFlows;
            charts.cumulativePaybackChart.update();
            ui.analysis.cumPayback.innerHTML = `La línea muestra la rentabilidad acumulada. Comienza con la inversión inicial (${formatUSD(data.initialInvestment)}) y se vuelve positiva en el <strong>mes ${data.paybackMonths}</strong>, momento en que se recupera la inversión.`;

            runMonteCarloSimulation(data);
        }

        function runMonteCarloSimulation(data) {
            const roiResults = [];
            for(let i = 0; i < 10000; i++) {
                const simulatedLeads = ROI_PARAMS.leads_per_ap_per_month * (1 + (Math.random() - 0.5) * 2 * ROI_PARAMS.leads_variation);
                const simulatedConversion = ROI_PARAMS.conversion_rate * (1 + (Math.random() - 0.5) * 2 * ROI_PARAMS.conversion_variation);
                
                const simMonthlyBenefit = data.totalApCount * simulatedLeads * simulatedConversion * data.customerLtv;
                const simTotalBenefit = simMonthlyBenefit * PROJECTION_MONTHS;
                const simROI = data.tco36Months > 0 ? ((simTotalBenefit - data.tco36Months) / data.tco36Months) * 100 : 0;
                roiResults.push(simROI);
            }
            const bins = { '<0%': 0, '0-50%': 0, '50-100%': 0, '100-150%': 0, '150-200%': 0, '>200%': 0 };
            roiResults.forEach(roi => {
                if (roi < 0) bins['<0%']++; else if (roi < 50) bins['0-50%']++; else if (roi < 100) bins['50-100%']++; else if (roi < 150) bins['100-150%']++; else if (roi < 200) bins['150-200%']++; else bins['>200%']++;
            });
            const labels = Object.keys(bins), simData = Object.values(bins), maxFreq = Math.max(...simData), mostLikelyBin = labels[simData.indexOf(maxFreq)];
            const backgroundColors = simData.map(d => d === maxFreq ? '#003f5c' : '#a05195');
            const positiveProbability = (simData.slice(1).reduce((a, b) => a + b, 0) / 10000) * 100;
            
            charts.monteCarloChart.data.labels = labels;
            charts.monteCarloChart.data.datasets[0].data = simData;
            charts.monteCarloChart.data.datasets[0].backgroundColor = backgroundColors;
            charts.monteCarloChart.update();
            ui.analysis.mc.innerHTML = `El rango de ROI más probable es <strong>${mostLikelyBin}</strong>, concentrando el <strong>${(maxFreq/10000*100).toFixed(0)}%</strong> de los escenarios. La probabilidad de un ROI positivo es del <strong>${positiveProbability.toFixed(0)}%</strong>.`;
        }

        function resetUI() {
            const initialText = "Ajuste los parámetros en el simulador para ejecutar el análisis.";
            Object.values(ui.analysis).forEach(el => el.innerHTML = initialText);
            ui.outputs.roi.textContent = '0%'; ui.outputs.payback.textContent = 'N/A';
            Object.values(charts).forEach(chart => {
                chart.data.datasets.forEach(dataset => dataset.data = []);
                chart.update();
            });
        }
        
        window.onload = initialize;
    </script>
</body>
</html>


