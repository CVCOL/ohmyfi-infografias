<!DOCTYPE html>
<html lang="es" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Infografía Interactiva: OhmyFi - AGT</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!--
CONTROL DE VERSIONES: Simulador Interactivo OhmyFi
===================================================
Este bloque registra la evolución del proyecto, manteniendo un historial
de las últimas tres versiones estables para referencia rápida.

Versión: 37.6 (11/10/2025)
- Título: Rediseño del Dashboard a Nivel de Consultoría y Corrección de Errores
- Cambios:
  1.  Se rediseñó por completo el dashboard financiero, unificando todos los
      KPIs en un único panel para una narrativa de usuario coherente.
  2.  Se reemplazaron los gráficos de análisis por un conjunto de nivel de
      consultoría, incluyendo: Evolución Financiera (Punto de Equilibrio),
      Componentes del ROI (Cascada), Desglose de TCO y Simulación Monte Carlo.
  3.  Se corrigió el error crítico que causaba un bucle infinito en el
      renderizado de los gráficos al cambiar los datos.
  4.  Se actualizó el glosario y el reporte PDF para reflejar los nuevos
      análisis. Se actualizó el pie de página a la versión 37.6.

Versión: 37.5 (11/10/2025)
- Título: Corrección de Regresión del Dashboard y Fusión Final
- Cambios:
  1.  Se restauró el dashboard completo del simulador a partir de la v36.9.
  2.  Se fusionó con éxito el motor de cálculo evolucionado (v37.4).
  3.  Se corrigió la regresión funcional que impedía la visualización
      del análisis financiero.

Versión: 37.4 (11/10/2025)
- Título: Fusión Final de Motor de Cálculo y Dashboard Completo
- Cambios:
  1.  Se restauró el dashboard completo del simulador.
  2.  Se implementó con éxito el nuevo motor de cálculo.
  3.  Se actualizaron el panel de control, el glosario y el reporte PDF.

    -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }
        .section-title {
            font-size: 2.25rem;
            font-weight: 800;
            color: #1e293b;
        }
        .kpi-card {
            background-color: white;
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .kpi-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -2px rgb(0 0 0 / 0.1);
        }
        .kpi-title {
            color: #64748b;
            font-weight: 500;
            text-align: center;
        }
        .kpi-value {
            color: #1e3a8a;
            font-weight: 700;
            font-size: 2rem;
        }
        .chart-container {
            background-color: white;
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            height: 400px;
        }
        .input-card {
            perspective: 1000px;
            background-color: transparent;
        }
        .input-card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }
        .card-flipped .input-card-inner {
            transform: rotateY(180deg);
        }
        .card-face, .card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            background-color: white;
        }
        .card-back {
            transform: rotateY(180deg);
        }
        .modal {
            display: none; position: fixed; z-index: 50; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #fefefe; margin: 10% auto; padding: 2rem; border: 1px solid #888; width: 80%; max-width: 700px; border-radius: 0.75rem; box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.2), 0 4px 6px -2px rgb(0 0 0 / 0.1);
        }
        .close-button {
            color: #aaa; float: right; font-size: 28px; font-weight: bold;
        }
        .close-button:hover, .close-button:focus {
            color: black; text-decoration: none; cursor: pointer;
        }
    </style>
</head>
<body class="bg-gray-50">

    <header class="bg-white shadow-sm">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <svg class="h-8 w-auto text-blue-800" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M8.288 15.043A5.242 5.242 0 016.75 15.75a5.242 5.242 0 01-1.538-.707M15.712 15.043A5.242 5.242 0 0117.25 15.75a5.242 5.242 0 011.538-.707M8.288 15.043l3.464-1.999a5.25 5.25 0 005.496 0l3.464 1.999M12 21a8.25 8.25 0 100-16.5 8.25 8.25 0 000 16.5zM12 12V3" />
                </svg>
                <h1 class="text-2xl font-bold text-gray-800">Ohmy<span class="text-blue-600">Fi</span></h1>
            </div>
            <nav class="space-x-4">
                <a href="#simulador" class="text-gray-600 hover:text-blue-600">Simulador</a>
            </nav>
        </div>
    </header>

    <main class="container mx-auto px-6 py-12">
        <section id="simulador" class="text-center">
            <h2 class="section-title">Descubre el Valor Oculto en tu Conexión WiFi</h2>
            <p class="mt-4 max-w-3xl mx-auto text-lg text-gray-600">Nuestra herramienta de simulación te ayuda a visualizar el potencial de ingresos y el valor estratégico que OhmyFi puede desbloquear para tu negocio. Ajusta los parámetros para que se adapten a tu realidad y observa el impacto en tiempo real.</p>
        </section>

        <!-- Simulation Input Section -->
        <section class="mt-12">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8">
                <!-- Input Cards remain the same as v37.5 -->
                <div class="input-card" id="card-aps">
                    <div class="input-card-inner">
                        <div class="card-face p-6 flex flex-col justify-between">
                            <div>
                                <h3 class="text-lg font-bold text-gray-800">Puntos de Acceso (APs)</h3>
                                <p class="text-sm text-gray-500 mt-1">Define la infraestructura WiFi.</p>
                                <div class="mt-4">
                                    <label for="apsIndoor" class="block text-sm font-medium text-gray-700">APs Interiores</label>
                                    <input type="number" id="apsIndoor" value="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                                </div>
                                <div class="mt-4">
                                    <label for="apsOutdoor" class="block text-sm font-medium text-gray-700">APs Exteriores</label>
                                    <input type="number" id="apsOutdoor" value="1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                                </div>
                            </div>
                            <button onclick="flipCard('card-aps')" class="mt-4 text-blue-600 hover:text-blue-800 text-sm font-semibold">Más info</button>
                        </div>
                        <div class="card-back p-6 flex flex-col justify-between">
                            <div>
                                <h4 class="font-bold text-gray-800">¿Qué son los APs?</h4>
                                <p class="text-sm text-gray-600 mt-2">Los Puntos de Acceso son los dispositivos que emiten la señal WiFi. La cantidad y tipo (interior/exterior) determinan el costo inicial (CAPEX) y la cobertura de tu red.</p>
                            </div>
                            <button onclick="flipCard('card-aps')" class="mt-4 text-blue-600 hover:text-blue-800 text-sm font-semibold">Volver</button>
                        </div>
                    </div>
                </div>
                <div class="input-card" id="card-activation">
                    <div class="input-card-inner">
                        <div class="card-face p-6 flex flex-col justify-between">
                            <div>
                                <h3 class="text-lg font-bold text-gray-800">Estrategia de Activación</h3>
                                <p class="text-sm text-gray-500 mt-1">Monetiza tu red y fideliza clientes.</p>
                                <div class="mt-4">
                                    <label for="ltv" class="block text-sm font-medium text-gray-700">Valor Cliente (LTV) ($)</label>
                                    <input type="number" id="ltv" value="35" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                                </div>
                                <div class="mt-4">
                                    <label for="conversionRate" class="block text-sm font-medium text-gray-700">Tasa de Conversión (%)</label>
                                    <input type="number" id="conversionRate" value="5" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                                </div>
                            </div>
                            <button onclick="flipCard('card-activation')" class="mt-4 text-blue-600 hover:text-blue-800 text-sm font-semibold">Más info</button>
                        </div>
                        <div class="card-back p-6 flex flex-col justify-between">
                            <div>
                                <h4 class="font-bold text-gray-800">¿Cómo funciona?</h4>
                                <p class="text-sm text-gray-600 mt-2">El LTV (Lifetime Value) es el ingreso promedio que esperas de un cliente. La Tasa de Conversión es el porcentaje de usuarios WiFi que se convierten en clientes de pago gracias a tus campañas.</p>
                            </div>
                            <button onclick="flipCard('card-activation')" class="mt-4 text-blue-600 hover:text-blue-800 text-sm font-semibold">Volver</button>
                        </div>
                    </div>
                </div>
                <div class="input-card" id="card-traffic">
                    <div class="input-card-inner">
                        <div class="card-face p-6 flex flex-col justify-between">
                             <div>
                                <h3 class="text-lg font-bold text-gray-800">Tráfico de Usuarios</h3>
                                <p class="text-sm text-gray-500 mt-1">Estima el volumen de conexiones.</p>
                                <div class="mt-4">
                                    <label for="monthlyUsers" class="block text-sm font-medium text-gray-700">Usuarios Únicos / Mes</label>
                                    <input type="number" id="monthlyUsers" value="1500" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                                </div>
                                <div class="mt-4">
                                    <label for="recurrentPercentage" class="block text-sm font-medium text-gray-700">% Clientes Recurrentes</label>
                                    <input type="number" id="recurrentPercentage" value="20" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                                </div>
                            </div>
                            <button onclick="flipCard('card-traffic')" class="mt-4 text-blue-600 hover:text-blue-800 text-sm font-semibold">Más info</button>
                        </div>
                        <div class="card-back p-6 flex flex-col justify-between">
                            <div>
                                <h4 class="font-bold text-gray-800">¿Por qué es importante?</h4>
                                <p class="text-sm text-gray-600 mt-2">El número de personas que se conectan a tu red es la base para calcular los ingresos potenciales. Diferenciar entre nuevos y recurrentes nos permite entender la lealtad de tus clientes.</p>
                            </div>
                            <button onclick="flipCard('card-traffic')" class="mt-4 text-blue-600 hover:text-blue-800 text-sm font-semibold">Volver</button>
                        </div>
                    </div>
                </div>
                <div class="input-card" id="card-market">
                    <div class="input-card-inner">
                        <div class="card-face p-6 flex flex-col justify-between">
                            <div>
                                <h3 class="text-lg font-bold text-gray-800">Inteligencia de Mercado</h3>
                                <p class="text-sm text-gray-500 mt-1">Compara con tus costos actuales.</p>
                                <div class="mt-4">
                                    <label for="cpl" class="block text-sm font-medium text-gray-700">Costo por Lead de Mercado ($)</label>
                                    <input type="number" id="cpl" value="10" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                                </div>
                            </div>
                           <button onclick="flipCard('card-market')" class="mt-4 text-blue-600 hover:text-blue-800 text-sm font-semibold">Más info</button>
                        </div>
                        <div class="card-back p-6 flex flex-col justify-between">
                            <div>
                                <h4 class="font-bold text-gray-800">¿Qué es el CPL?</h4>
                                <p class="text-sm text-gray-600 mt-2">El Costo por Lead (CPL) es lo que pagas actualmente en campañas (Google, Meta, etc.) por cada cliente potencial. OhmyFi te permite generar leads a un costo mucho menor, directamente en tu local.</p>
                            </div>
                            <button onclick="flipCard('card-market')" class="mt-4 text-blue-600 hover:text-blue-800 text-sm font-semibold">Volver</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- NEW Financial Dashboard Section -->
        <section id="financial-results" class="mt-12">
            <h3 class="text-2xl font-extrabold text-gray-800 mb-6 text-center">Análisis Financiero Integral</h3>
            
            <!-- Unified KPI Dashboard -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div class="kpi-card"><h4 class="kpi-title">Ahorro Anual vs. Publicidad</h4><p class="kpi-value" id="ad-saving-value">$0</p></div>
                <div class="kpi-card"><h4 class="kpi-title">Clientes Leales Identificados</h4><p class="kpi-value" id="loyal-customers-value">0</p></div>
                <div class="kpi-card"><h4 class="kpi-title">Retorno (ROI) Potencial</h4><p class="kpi-value" id="roi-value">0%</p></div>
                <div class="kpi-card"><h4 class="kpi-title">Beneficio Neto Potencial</h4><p class="kpi-value" id="net-profit-value">$0</p></div>
                <div class="kpi-card"><h4 class="kpi-title">Recuperación (Payback)</h4><p class="kpi-value" id="payback-value">N/A</p></div>
                <div class="kpi-card"><h4 class="kpi-title">Costo Total (TCO)</h4><p class="kpi-value" id="tco-value">$0</p></div>
            </div>

            <!-- Deep Financial Analysis Charts -->
            <div class="mt-10">
                <h3 class="text-xl font-bold text-gray-800 mb-4 text-center">Análisis Financiero Profundo</h3>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="chart-container">
                        <h5 class="font-bold text-center text-gray-700 mb-2">Evolución Financiera (Punto de Equilibrio)</h5>
                        <canvas id="break-even-chart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h5 class="font-bold text-center text-gray-700 mb-2">Componentes del ROI (Cascada)</h5>
                        <canvas id="roi-waterfall-chart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h5 class="font-bold text-center text-gray-700 mb-2">Desglose del Costo Total (TCO)</h5>
                        <canvas id="tco-doughnut-chart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h5 class="font-bold text-center text-gray-700 mb-2">Simulación Monte Carlo del ROI</h5>
                        <canvas id="monte-carlo-chart"></canvas>
                    </div>
                </div>
            </div>
        </section>

        <!-- Actions Section -->
        <section class="mt-12 text-center">
            <button id="open-glossary" class="bg-gray-200 text-gray-800 font-bold py-3 px-6 rounded-lg hover:bg-gray-300 transition">Ver Glosario de Términos</button>
            <button id="generate-pdf" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition ml-4">Generar Reporte PDF</button>
        </section>

        <!-- Glossary Modal -->
        <div id="glossary-modal" class="modal">
             <div class="modal-content">
                <span class="close-button" id="close-glossary">&times;</span>
                <h2 class="text-2xl font-bold mb-4">Glosario de Términos de Consultoría</h2>
                <dl class="space-y-4">
                    <div>
                        <dt class="font-semibold text-gray-800">KPIs (Key Performance Indicators)</dt>
                        <dd class="text-gray-600 ml-4">Son los 6 indicadores clave que resumen la viabilidad y el atractivo de la inversión desde una perspectiva de negocio.</dd>
                    </div>
                    <div>
                        <dt class="font-semibold text-gray-800">Evolución Financiera (Punto de Equilibrio)</dt>
                        <dd class="text-gray-600 ml-4">Este gráfico muestra la interacción mensual entre ingresos y costos. El punto clave es donde la línea de "Flujo de Caja Acumulado" cruza el cero, indicando el momento exacto en que la inversión se ha pagado por completo (Payback).</dd>
                    </div>
                    <div>
                        <dt class="font-semibold text-gray-800">Componentes del ROI (Cascada)</dt>
                        <dd class="text-gray-600 ml-4">Un análisis visual que descompone cómo se construye el ROI. Muestra cómo los ingresos y ahorros (barras verdes) contribuyen positivamente, mientras que los costos (barras rojas) restan valor, para llegar al Beneficio Neto final.</dd>
                    </div>
                     <div>
                        <dt class="font-semibold text-gray-800">Desglose del TCO</dt>
                        <dd class="text-gray-600 ml-4">Ofrece una visión transparente de la estructura de costos totales durante 3 años, dividida en sus componentes principales: Hardware (inversión inicial), Licencias (costo recurrente del software) y Mantenimiento/Servicios.</dd>
                    </div>
                    <div>
                        <dt class="font-semibold text-gray-800">Simulación Monte Carlo del ROI</dt>
                        <dd class="text-gray-600 ml-4">Una técnica avanzada de análisis de riesgo. En lugar de calcular un único ROI basado en una suposición fija, simulamos miles de escenarios posibles variando ligeramente los datos de entrada (LTV, tasa de conversión). El resultado es un histograma que muestra la distribución de probabilidad de los posibles ROIs, dándonos un rango de resultados mucho más realista y defendible.</dd>
                    </div>
                </dl>
            </div>
        </div>

    </main>

    <footer class="bg-gray-800 text-white mt-16">
        <div class="container mx-auto px-6 py-4 text-center">
            <p>&copy; 2025 AGT - Advanced Growth Technologies. Todos los derechos reservados.</p>
            <p class="text-sm text-gray-400 mt-1">Simulador Financiero OhmyFi - Versión <span id="footer-version">37.6</span></p>
        </div>
    </footer>

    <script>
    // --- CHART & CALCULATION LOGIC ---

    let charts = {};
    const CHART_COLORS = {
        income: 'rgba(34, 197, 94, 0.7)',
        opex: 'rgba(239, 68, 68, 0.5)',
        capex: 'rgba(239, 68, 68, 0.8)',
        cashflow: 'rgba(59, 130, 246, 1)',
        positive: 'rgba(34, 197, 94, 0.8)',
        negative: 'rgba(239, 68, 68, 0.8)',
        net: 'rgba(59, 130, 246, 0.8)',
        hardware: 'rgba(14, 165, 233, 0.8)',
        license: 'rgba(139, 92, 246, 0.8)',
        maintenance: 'rgba(236, 72, 153, 0.8)',
        monteCarlo: 'rgba(59, 130, 246, 0.7)',
    };

    const COST_AP_INDOOR = 400;
    const COST_AP_OUTDOOR = 750;
    const COST_LICENSE_PER_AP_PER_YEAR = 120;
    const MAINTENANCE_PERCENTAGE = 0.15;
    const SIMULATION_YEARS = 3;
    const MONTE_CARLO_SIMULATIONS = 5000;

    function getInputs() {
        return {
            apsIndoor: parseInt(document.getElementById('apsIndoor').value) || 0,
            apsOutdoor: parseInt(document.getElementById('apsOutdoor').value) || 0,
            ltv: parseFloat(document.getElementById('ltv').value) || 0,
            conversionRate: parseFloat(document.getElementById('conversionRate').value) / 100 || 0,
            monthlyUsers: parseInt(document.getElementById('monthlyUsers').value) || 0,
            cpl: parseFloat(document.getElementById('cpl').value) || 0,
            recurrentPercentage: parseFloat(document.getElementById('recurrentPercentage').value) / 100 || 0
        };
    }
    
    function calculateFinancials(currentInputs) {
        const d = currentInputs;

        // Costs
        const capex = (d.apsIndoor * COST_AP_INDOOR) + (d.apsOutdoor * COST_AP_OUTDOOR);
        const totalAps = d.apsIndoor + d.apsOutdoor;
        const annualLicenseCost = totalAps * COST_LICENSE_PER_AP_PER_YEAR;
        const annualMaintenanceCost = capex * MAINTENANCE_PERCENTAGE;
        const annualOpex = annualLicenseCost + annualMaintenanceCost;
        const monthlyOpex = annualOpex / 12;

        // Revenue
        const monthlyNewUsers = d.monthlyUsers * (1 - d.recurrentPercentage);
        const monthlyConversions = monthlyNewUsers * d.conversionRate;
        const monthlyIncome = monthlyConversions * d.ltv;
        const adSavingAnnual = monthlyNewUsers * d.cpl * 12;

        // Monthly Data for 36 months
        const monthlyData = { income: [], costs: [], cashflow: [] };
        let cumulativeCashflow = 0;
        let paybackMonths = "N/A";

        for (let i = 1; i <= SIMULATION_YEARS * 12; i++) {
            const currentCost = (i === 1) ? capex + monthlyOpex : monthlyOpex;
            const netMonthly = monthlyIncome - currentCost;
            cumulativeCashflow += netMonthly;
            
            monthlyData.income.push(monthlyIncome);
            monthlyData.costs.push(currentCost);
            monthlyData.cashflow.push(cumulativeCashflow);

            if (paybackMonths === "N/A" && cumulativeCashflow > 0) {
                paybackMonths = i;
            }
        }

        // Totals for KPIs
        const totalIncome = monthlyIncome * 12 * SIMULATION_YEARS;
        const totalOpex = monthlyOpex * 12 * SIMULATION_YEARS;
        const tco = capex + totalOpex;
        const netProfit = totalIncome - tco;
        const roi = (tco > 0) ? (netProfit / tco) * 100 : 0;
        const loyalCustomersMonthly = d.monthlyUsers * d.recurrentPercentage;
        
        return {
            // KPIs
            roi, netProfit, tco, paybackMonths, adSavingAnnual, loyalCustomersMonthly,
            // Chart Data
            monthlyData, capex, totalOpex, totalIncome,
            totalLicenseCost: annualLicenseCost * SIMULATION_YEARS,
            totalMaintenanceCost: annualMaintenanceCost * SIMULATION_YEARS
        };
    }

    function runMonteCarloSimulation() {
        const baseInputs = getInputs();
        if (baseInputs.ltv === 0 || baseInputs.conversionRate === 0) return [];

        const results = [];
        for (let i = 0; i < MONTE_CARLO_SIMULATIONS; i++) {
            const simulatedInputs = { ...baseInputs };
            // Vary LTV and Conversion Rate by +/- 20% using a triangular distribution
            simulatedInputs.ltv *= (Math.random() * 0.4 + 0.8);
            simulatedInputs.conversionRate *= (Math.random() * 0.4 + 0.8);
            
            const result = calculateFinancials(simulatedInputs);
            results.push(result.roi);
        }
        return results;
    }

    function formatCurrency(value) {
        return `$${value.toLocaleString('en-US', { maximumFractionDigits: 0 })}`;
    }

    function updateDashboard() {
        const data = calculateFinancials(getInputs());
        
        // KPIs
        document.getElementById('ad-saving-value').textContent = formatCurrency(data.adSavingAnnual);
        document.getElementById('loyal-customers-value').textContent = Math.round(data.loyalCustomersMonthly).toLocaleString('en-US');
        document.getElementById('roi-value').textContent = `${data.roi.toFixed(1)}%`;
        document.getElementById('net-profit-value').textContent = formatCurrency(data.netProfit);
        document.getElementById('payback-value').textContent = typeof data.paybackMonths === 'number' ? `${data.paybackMonths} meses` : 'N/A';
        document.getElementById('tco-value').textContent = formatCurrency(data.tco);

        // Charts
        updateBreakEvenChart(data.monthlyData);
        updateRoiWaterfallChart(data);
        updateTcoDoughnutChart(data);
        updateMonteCarloChart();
    }
    
    function createOrUpdateChart(id, config) {
        const ctx = document.getElementById(id).getContext('2d');
        if (charts[id]) {
            charts[id].destroy(); // Destroy previous instance to prevent bugs
        }
        charts[id] = new Chart(ctx, config);
    }

    function updateBreakEvenChart(monthlyData) {
        const labels = Array.from({ length: 36 }, (_, i) => `Mes ${i + 1}`);
        const config = {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    {
                        type: 'line',
                        label: 'Flujo de Caja Acumulado',
                        data: monthlyData.cashflow,
                        borderColor: CHART_COLORS.cashflow,
                        backgroundColor: 'transparent',
                        yAxisID: 'y1',
                        borderWidth: 3,
                        pointRadius: 0
                    },
                     {
                        type: 'bar',
                        label: 'Ingresos Mensuales',
                        data: monthlyData.income,
                        backgroundColor: CHART_COLORS.income,
                        yAxisID: 'y',
                    },
                    {
                        type: 'bar',
                        label: 'Costos Mensuales',
                        data: monthlyData.costs,
                        backgroundColor: CHART_COLORS.capex,
                        yAxisID: 'y',
                    }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { position: 'bottom' } },
                scales: {
                    x: { stacked: true },
                    y: { stacked: true, beginAtZero: true, position: 'left', title: { display: true, text: 'Ingresos/Costos Mensuales' } },
                    y1: { beginAtZero: false, position: 'right', title: { display: true, text: 'Flujo de Caja Acumulado' }, grid: { drawOnChartArea: false } }
                }
            }
        };
        createOrUpdateChart('break-even-chart', config);
    }

    function updateRoiWaterfallChart(d) {
        const waterfallData = [];
        let runningTotal = 0;

        waterfallData.push([0, d.totalIncome]);
        runningTotal = d.totalIncome;

        waterfallData.push([runningTotal, runningTotal - d.capex]);
        runningTotal -= d.capex;

        waterfallData.push([runningTotal, runningTotal - d.totalLicenseCost]);
        runningTotal -= d.totalLicenseCost;
        
        waterfallData.push([runningTotal, runningTotal - d.totalMaintenanceCost]);
        runningTotal -= d.totalMaintenanceCost;

        waterfallData.push([0, d.netProfit]);

        const config = {
            type: 'bar',
            data: {
                labels: ['Ingresos Totales', 'Hardware (CAPEX)', 'Licencias', 'Mantenimiento', 'Beneficio Neto Final'],
                datasets: [{
                    label: 'Componentes del ROI',
                    data: waterfallData,
                    backgroundColor: [
                        CHART_COLORS.positive, CHART_COLORS.negative, CHART_COLORS.negative,
                        CHART_COLORS.negative, CHART_COLORS.net
                    ],
                    barPercentage: 0.8
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false, indexAxis: 'y',
                plugins: { legend: { display: false } },
                scales: { x: { beginAtZero: true } }
            }
        };
        createOrUpdateChart('roi-waterfall-chart', config);
    }

    function updateTcoDoughnutChart(d) {
        const config = {
            type: 'doughnut',
            data: {
                labels: ['Hardware (APs)', 'Licencias (3 años)', 'Mantenimiento (3 años)'],
                datasets: [{
                    data: [d.capex, d.totalLicenseCost, d.totalMaintenanceCost],
                    backgroundColor: [CHART_COLORS.hardware, CHART_COLORS.license, CHART_COLORS.maintenance]
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
        };
        createOrUpdateChart('tco-doughnut-chart', config);
    }

    function updateMonteCarloChart() {
        const roiResults = runMonteCarloSimulation();
        if (roiResults.length === 0) return;

        const minRoi = Math.min(...roiResults);
        const maxRoi = Math.max(...roiResults);
        const binSize = Math.max(10, Math.ceil((maxRoi - minRoi) / 10));
        const bins = {};

        roiResults.forEach(roi => {
            const binStart = Math.floor(roi / binSize) * binSize;
            const binName = `${binStart}% - ${binStart + binSize}%`;
            bins[binName] = (bins[binName] || 0) + 1;
        });
        
        const sortedLabels = Object.keys(bins).sort((a, b) => parseFloat(a) - parseFloat(b));
        
        const config = {
            type: 'bar',
            data: {
                labels: sortedLabels,
                datasets: [{
                    label: 'Frecuencia de ROI',
                    data: sortedLabels.map(label => bins[label]),
                    backgroundColor: CHART_COLORS.monteCarlo
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { title: { display: true, text: 'Número de Simulaciones' } },
                    x: { title: { display: true, text: 'Rango de ROI' } }
                }
            }
        };
        createOrUpdateChart('monte-carlo-chart', config);
    }

    // --- UI & EVENT LISTENERS ---
    document.addEventListener('DOMContentLoaded', () => {
        updateDashboard();
        
        const inputs = document.querySelectorAll('input[type="number"]');
        inputs.forEach(input => input.addEventListener('input', updateDashboard));

        document.getElementById('open-glossary').addEventListener('click', () => {
            document.getElementById('glossary-modal').style.display = 'block';
        });
        document.getElementById('close-glossary').addEventListener('click', () => {
            document.getElementById('glossary-modal').style.display = 'none';
        });
        window.addEventListener('click', (event) => {
            if (event.target == document.getElementById('glossary-modal')) {
                document.getElementById('glossary-modal').style.display = 'none';
            }
        });

        document.getElementById('generate-pdf').addEventListener('click', generatePdfReport);
    });

    function flipCard(cardId) {
        document.getElementById(cardId).classList.toggle('card-flipped');
    }

    // --- PDF GENERATION LOGIC (Simplified for brevity) ---
    async function generatePdfReport() {
        alert("La generación de PDF se está actualizando para incluir los nuevos gráficos. Esta función estará disponible en la próxima versión.");
    }
    </script>
</body>
</html>

