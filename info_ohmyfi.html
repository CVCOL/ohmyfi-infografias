<!--
CONTROL DE VERSIONES: Simulador Interactivo OhmyFi
===================================================
Este bloque registra la evolución del proyecto, manteniendo un historial
de las últimas tres versiones estables para referencia rápida.

Versión: 39.0 (11/10/2025)
- Título: Hotfix Crítico: Reparación de Motor de Cálculo y Generador de PDF
- Cambios:
  1. (JS/CÁLCULO) Se confirmó que los event listeners para 'apsIndoor' y
     'apsOutdoor' ya estaban correctos en la función initialize(), asegurando
     la interactividad total del motor de cálculo.
  2. (JS/PDF CRÍTICO) Se refactorizó la lógica de la tabla de KPIs del PDF.
     Se creó la función getKpiTableData() para centralizar y estandarizar
     la estructura de datos (Array de Arrays) que requiere jspdf-autotable,
     eliminando el error de script que impedía la generación del PDF.
  3. (JS/COMENTARIO) Se actualizó el pie de página a la versión 39.0 y se
     ajustó la fecha de la versión en el bloque de control.

Versión: 38.4 (11/10/2025)
- Título: Reparaciones de Lógica de Negocio y Estabilidad
- Cambios:
  1. (JS/LÓGICA) Se corrigió la función generateConsultantAnalysis() para
     garantizar que el texto de análisis no sea vacío.
  2. (JS/CÁLCULO) Se revisó la función calculate() para asegurar que el
     Beneficio Neto siempre sea evaluado como un número.
  3. (JS/CÁLCULO) Se ajustó la fórmula del Payback para que el cálculo sea
     más conservador y lineal.
  4. (JS/COMENTARIO) Se actualizó el pie de página a la versión 38.4.

Versión: 38.3 (11/10/2025)
- Título: Rediseño de Layout y Refuerzo de Mensaje en PDF
- Cambios:
  1.  (PDF/DISEÑO) Se ajustó el layout de la sección "Validación" en el PDF.
  2.  (PDF/CONTENIDO) Se rediseñó la sección "City Park" como un mini-caso
      de estudio de alto impacto.
  3.  (PDF/DISEÑO) Se optimizó la configuración de la tabla de KPIs.
  4.  (PDF/DISEÑO) Se aseguró la correcta implementación del salto de página
      antes de la sección de "Análisis del Consultor".
  5.  Se actualizó el pie de página a la versión 38.3.
-->
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador OhmyFi - AGT Consultores</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #0F172A; color: #E2E8F0; }
        .card-flip { perspective: 1000px; }
        .card-inner { transition: transform 0.6s; transform-style: preserve-3d; }
        .card-flip:hover .card-inner { transform: rotateY(180deg); }
        .card-front, .card-back { backface-visibility: hidden; }
        .card-back { transform: rotateY(180deg); position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        /* Estilo para los iconos de Lucide (simulación) */
        .icon { display: inline-block; width: 24px; height: 24px; }
        /* Estilos específicos para la estética oscura y naranja */
        .bg-dark-blue { background-color: #0F172A; }
        .text-orange { color: #F97316; }
        .bg-orange-600 { background-color: #F97316; }
        .hover-shadow:hover { box-shadow: 0 4px 15px rgba(249, 115, 22, 0.4); }
        .shadow-glow { box-shadow: 0 0 20px rgba(249, 115, 22, 0.25); }
        .input-range-thumb::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #F97316;
            cursor: pointer;
            border: 2px solid #0F172A;
            box-shadow: 0 0 5px rgba(249, 115, 22, 0.5);
        }
        .input-range-thumb::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #F97316;
            cursor: pointer;
            border: 2px solid #0F172A;
            box-shadow: 0 0 5px rgba(249, 115, 22, 0.5);
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- Header y Título Principal -->
    <header class="bg-[#1E293B] shadow-lg py-4">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex justify-between items-center">
            <h1 class="text-3xl font-extrabold text-white tracking-tight">
                Simulador OhmyFi <span class="text-orange">Estratégico</span>
            </h1>
            <span class="text-sm text-gray-400">AGT Consultores | v39.0</span>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">

        <!-- Sección de Introducción y Narrativa de Valor -->
        <section class="mb-16">
            <h2 class="text-4xl font-bold mb-4 text-center">
                De un <span class="text-red-500">Gasto</span> a un <span class="text-green-400">Activo Estratégico</span>
            </h2>
            <p class="text-center text-lg text-gray-400 max-w-3xl mx-auto">
                OhmyFi + Zoho no es solo Wi-Fi para invitados, es el canal que convierte la conectividad en datos accionables, clientes leales e ingresos medibles.
            </p>

            <!-- Grid de Narrativa de Ventaja Estratégica con Flip Cards -->
            <div class="mt-12 grid grid-cols-1 md:grid-cols-3 gap-8">
                <!-- Card 1: Adquisición de Datos (Front) -->
                <div class="card-flip h-64">
                    <div class="card-inner shadow-xl rounded-xl border border-gray-700">
                        <div class="card-front bg-[#1E293B] p-6 rounded-xl flex flex-col justify-center items-center">
                            <svg class="icon text-orange mb-3 w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                            <h3 class="text-xl font-semibold text-white mb-2">1. Captura de Valor</h3>
                            <p class="text-center text-gray-400 text-sm">El 95% de los datos de contacto se pierden. OhmyFi los captura al instante.</p>
                        </div>
                        <div class="card-back bg-orange-600 p-6 rounded-xl flex flex-col justify-center items-center text-black">
                            <p class="text-center text-lg font-bold">Base de Datos Propia</p>
                            <p class="text-center text-sm mt-2">Convierte cada visita en un perfil enriquecido, listo para ser segmentado y monetizado.</p>
                        </div>
                    </div>
                </div>

                <!-- Card 2: Clientes Leales (Front) -->
                <div class="card-flip h-64">
                    <div class="card-inner shadow-xl rounded-xl border border-gray-700">
                        <div class="card-front bg-[#1E293B] p-6 rounded-xl flex flex-col justify-center items-center">
                            <svg class="icon text-orange mb-3 w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M12 20a9 9 0 100-18 9 9 0 000 18z"></path></svg>
                            <h3 class="text-xl font-semibold text-white mb-2">2. Lealtad Medible</h3>
                            <p class="text-center text-gray-400 text-sm">Identifica y recompensa a tus clientes más valiosos con automatización.</p>
                        </div>
                        <div class="card-back bg-orange-600 p-6 rounded-xl flex flex-col justify-center items-center text-black">
                            <p class="text-center text-lg font-bold">Marketing de Precisión</p>
                            <p class="text-center text-sm mt-2">Re-impacta a los visitantes con ofertas hiper-relevantes basadas en su historial.</p>
                        </div>
                    </div>
                </div>

                <!-- Card 3: Impacto Financiero (Front) -->
                <div class="card-flip h-64">
                    <div class="card-inner shadow-xl rounded-xl border border-gray-700">
                        <div class="card-front bg-[#1E293B] p-6 rounded-xl flex flex-col justify-center items-center">
                            <svg class="icon text-orange mb-3 w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 6l3 1m0 0l-3 7v10h18V13l-3-7m0 0l-3 7m0 0V3m0 3h7"></path></svg>
                            <h3 class="text-xl font-semibold text-white mb-2">3. Retorno de Inversión</h3>
                            <p class="text-center text-gray-400 text-sm">El simulador te mostrará el TCO, Payback y ROI en solo 3 minutos.</p>
                        </div>
                        <div class="card-back bg-orange-600 p-6 rounded-xl flex flex-col justify-center items-center text-black">
                            <p class="text-center text-lg font-bold">Decisión Basada en Datos</p>
                            <p class="text-center text-sm mt-2">Valida la inversión con proyecciones de flujo de caja y análisis de riesgo.</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Sección de Simulador Interactivo -->
        <section id="simulator" class="mt-16 bg-[#1E293B] p-8 rounded-xl shadow-2xl shadow-glow border border-gray-700">
            <h2 class="text-3xl font-bold text-center mb-10 border-b border-gray-700 pb-4">
                Simulador de Rentabilidad <span class="text-orange">Financiera</span>
            </h2>

            <!-- Controles de Usuario -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-10">
                <!-- Control 1: Nº de APs Interior -->
                <div class="flex flex-col">
                    <label for="apsIndoor" class="text-gray-400 text-sm mb-2">Nº de Puntos de Acceso (Interior)</label>
                    <input type="number" id="apsIndoor" value="1" min="1" max="10" class="bg-[#0F172A] text-white p-3 rounded-lg border border-gray-700 focus:ring-orange focus:border-orange transition duration-200">
                </div>
                <!-- Control 2: Nº de APs Exterior -->
                <div class="flex flex-col">
                    <label for="apsOutdoor" class="text-gray-400 text-sm mb-2">Nº de Puntos de Acceso (Exterior)</label>
                    <input type="number" id="apsOutdoor" value="0" min="0" max="5" class="bg-[#0F172A] text-white p-3 rounded-lg border border-gray-700 focus:ring-orange focus:border-orange transition duration-200">
                </div>
                <!-- Control 3: LTV (Valor de Vida del Cliente) -->
                <div class="flex flex-col">
                    <label for="ltv" class="text-gray-400 text-sm mb-2">Valor de Vida del Cliente (LTV, USD)</label>
                    <input type="range" id="ltv" min="5" max="100" step="5" value="30" class="input-range-thumb w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer">
                    <span id="ltvValue" class="text-lg font-bold text-orange mt-2">$30</span>
                </div>
                <!-- Control 4: Tasa de Conversión -->
                <div class="flex flex-col">
                    <label for="conversionRate" class="text-gray-400 text-sm mb-2">Tasa de Conversión (a Cliente Pagado)</label>
                    <input type="range" id="conversionRate" min="0.01" max="0.10" step="0.01" value="0.05" class="input-range-thumb w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer">
                    <span id="conversionRateValue" class="text-lg font-bold text-orange mt-2">5%</span>
                </div>
            </div>

            <!-- Resultados Clave (Nivel 1: Valor del Activo) -->
            <div class="mb-10 p-6 bg-[#0F172A] rounded-xl border border-orange-600/30">
                <h3 class="text-2xl font-semibold mb-4 text-orange">Resultados Inmediatos (Nivel 1: Valor del Activo)</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="p-4 bg-[#1E293B] rounded-lg shadow-md">
                        <p class="text-sm text-gray-400">Ahorro Anual vs. Publicidad</p>
                        <p id="kpiAhorroPublicidad" class="text-2xl font-extrabold text-green-400 mt-1">$1,200</p>
                    </div>
                    <div class="p-4 bg-[#1E293B] rounded-lg shadow-md">
                        <p class="text-sm text-gray-400">Clientes Leales Identificados (Anual)</p>
                        <p id="kpiClientesLeales" class="text-2xl font-extrabold text-orange mt-1">12,000</p>
                    </div>
                    <div class="p-4 bg-[#1E293B] rounded-lg shadow-md">
                        <p class="text-sm text-gray-400">Potencial de Ingreso Anual (Activado)</p>
                        <p id="kpiIngresoPotencial" class="text-2xl font-extrabold text-white mt-1">$1,800</p>
                    </div>
                </div>
            </div>

            <!-- Resultados Clave (Nivel 2: Rentabilidad) -->
            <div class="mb-10 p-6 bg-[#1E293B] rounded-xl border border-gray-700">
                <h3 class="text-2xl font-semibold mb-4 text-white">Análisis Financiero Clave (Nivel 2: Rentabilidad)</h3>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <div class="text-center p-4 bg-[#0F172A] rounded-lg shadow-md border border-gray-700">
                        <p class="text-sm text-gray-400">Retorno de Inversión (ROI)</p>
                        <p id="kpiRoi" class="text-3xl font-extrabold text-orange mt-1">150%</p>
                    </div>
                    <div class="text-center p-4 bg-[#0F172A] rounded-lg shadow-md border border-gray-700">
                        <p class="text-sm text-gray-400">Tiempo de Recuperación (Payback)</p>
                        <p id="kpiPayback" class="text-3xl font-extrabold text-green-400 mt-1">8 meses</p>
                    </div>
                    <div class="text-center p-4 bg-[#0F172A] rounded-lg shadow-md border border-gray-700">
                        <p class="text-sm text-gray-400">Costo Total de Propiedad (TCO)</p>
                        <p id="kpiTco" class="text-3xl font-extrabold text-red-500 mt-1">$2,000</p>
                    </div>
                    <div class="text-center p-4 bg-[#0F172A] rounded-lg shadow-md border border-gray-700">
                        <p class="text-sm text-gray-400">Beneficio Neto (5 Años)</p>
                        <p id="kpiBeneficioNeto" class="text-3xl font-extrabold text-white mt-1">$5,000</p>
                    </div>
                </div>
            </div>

            <!-- Gráficos de Análisis Profundo (Nivel 3 y 4) -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Gráfico de Flujo de Caja -->
                <div class="bg-[#1E293B] p-6 rounded-xl shadow-md border border-gray-700">
                    <h3 class="text-xl font-semibold mb-4 text-white">Flujo de Caja Proyectado (5 Años)</h3>
                    <canvas id="cashflowChart"></canvas>
                </div>
                <!-- Gráfico de Análisis de Riesgo -->
                <div class="bg-[#1E293B] p-6 rounded-xl shadow-md border border-gray-700">
                    <h3 class="text-xl font-semibold mb-4 text-white">Simulación de Riesgo (Monte Carlo)</h3>
                    <canvas id="riskChart"></canvas>
                </div>
            </div>

            <!-- Botón de Generación de Reporte -->
            <div class="mt-12 text-center">
                <button id="generatePdfButton" onclick="generatePDF()" class="bg-orange-600 text-black font-bold py-4 px-10 rounded-full text-lg uppercase tracking-wider hover-shadow transition duration-300 transform hover:scale-[1.03]">
                    Generar Informe de Consultoría (PDF)
                </button>
            </div>
        </section>

        <!-- Sección de Caso de Éxito (City Park) y Confiabilidad -->
        <section class="mt-20">
            <h2 class="text-4xl font-bold text-center mb-10 border-b border-gray-700 pb-4">
                Prueba Irrefutable: Caso de Éxito <span class="text-orange">City Park</span>
            </h2>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 items-start">
                <!-- Columna de KPIs del Caso de Estudio -->
                <div class="lg:col-span-1 bg-[#1E293B] p-6 rounded-xl shadow-md border border-gray-700">
                    <h3 class="text-2xl font-semibold mb-4 text-orange">KPIs Activados (12 Meses)</h3>
                    <div class="space-y-4">
                        <div class="border-b border-gray-700 pb-3">
                            <p class="text-sm text-gray-400">Perfiles de Clientes Capturados</p>
                            <p class="text-4xl font-extrabold text-white">125K+</p>
                        </div>
                        <div class="border-b border-gray-700 pb-3">
                            <p class="text-sm text-gray-400">Tasa de Recurrencia (Lealtad)</p>
                            <p class="text-4xl font-extrabold text-green-400">62%</p>
                        </div>
                        <div class="border-b border-gray-700 pb-3">
                            <p class="text-sm text-gray-400">Campaña de Venta Activa (ROI estimado)</p>
                            <p class="text-4xl font-extrabold text-orange">190%</p>
                        </div>
                    </div>
                </div>

                <!-- Columna de Gráfico y Explicación -->
                <div class="lg:col-span-2 bg-[#1E293B] p-6 rounded-xl shadow-md border border-gray-700">
                    <h3 class="text-xl font-semibold mb-4 text-white">Evolución: Nuevos vs. Recurrentes</h3>
                    <p class="text-gray-400 mb-4">El gráfico demuestra el poder de la base de datos: la línea de nuevos clientes se estabiliza, pero los clientes recurrentes, impulsados por Zoho CRM, sostienen el crecimiento.</p>
                    <canvas id="cityParkChart"></canvas>
                </div>
            </div>
        </section>

    </main>

    <!-- Footer -->
    <footer class="mt-20 bg-[#1E293B] py-6">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center text-gray-400 text-sm">
            <p>&copy; 2025 AGT Consultores. OhmyFi + Zoho CRM Plus. | Versión del Simulador: 39.0</p>
        </div>
    </footer>

<!--
    ========================================================
    LÓGICA DE JAVASCRIPT: MOTOR DE CÁLCULO Y GENERACIÓN DE PDF
    ========================================================
    NOTA: Las funciones calculate(), updateUI(), generatePDF() y sus
    dependencias son la parte crítica de la lógica de negocio.
-->
<script>
    // Variables globales para Chart.js
    let cashflowChartInstance;
    let riskChartInstance;
    let cityParkChartInstance;

    // --- Definiciones de Costos (Basado en la Estrategia) ---
    // Valores Fijos para la simulación
    const COSTOS_FIJOS = {
        SETUP_COST_BASE: 500,        // Costo base de implementación (horas de consultoría, cableado, etc.)
        LICENCIA_SOFTWARE_ANUAL: 360, // Costo de licencias de software (OhmyFi + Zoho Básico)
        AP_COST_INDOOR: 350,         // Costo por unidad de AP de interior (incluye margen)
        AP_COST_OUTDOOR: 500         // Costo por unidad de AP de exterior
    };

    // --- Supuestos de Negocio ---
    // Estos supuestos son la clave para calcular el Ahorro vs. Publicidad.
    const SUPUESTOS_NEGOCIO = {
        // Un perfil de cliente capturado (email, teléfono, data) se valora en USD 0.10.
        // Se asume que el costo de adquisición por publicidad tradicional (Google/FB) es 0.10/contacto.
        COSTO_POR_PERFIL_AHORRADO: 0.10,
        // Conexiones promedio por AP al mes (un AP soporta ~150-200, usamos 100 como base conservadora)
        PERFILES_POR_AP_MENSUAL: 1000,
        // Tasa de recurrencia promedio esperada, usada solo para el KPI de Clientes Leales.
        TASA_RECURRENCIA_BASE: 0.50
    };

    /**
     * @brief Calcula todos los KPIs financieros y de negocio en función de los inputs del usuario.
     * @param {number} apsIndoor - Cantidad de puntos de acceso de interior.
     * @param {number} apsOutdoor - Cantidad de puntos de acceso de exterior.
     * @param {number} ltv - Valor de vida del cliente (en USD).
     * @param {number} conversionRate - Tasa de conversión de perfil capturado a cliente pagado (0.0 a 1.0).
     * @returns {object} Un objeto con todos los resultados calculados.
     */
    function calculate(apsIndoor, apsOutdoor, ltv, conversionRate) {
        // --- Cálculo de Inversión Inicial y Recurrente ---
        const totalAps = apsIndoor + apsOutdoor;
        const totalHardwareCost = (apsIndoor * COSTOS_FIJOS.AP_COST_INDOOR) + (apsOutdoor * COSTOS_FIJOS.AP_COST_OUTDOOR);
        const totalInitialInvestment = COSTOS_FIJOS.SETUP_COST_BASE + totalHardwareCost;
        const totalAnnualOpex = COSTOS_FIJOS.LICENCIA_SOFTWARE_ANUAL * totalAps; // Licencia por AP

        // --- Cálculo de Valor del Activo (Ingreso no-transaccional) ---
        const annualProfilesCaptured = totalAps * SUPUESTOS_NEGOCIO.PERFILES_POR_AP_MENSUAL * 12;
        const ahorroPublicidadAnual = annualProfilesCaptured * SUPUESTOS_NEGOCIO.COSTO_POR_PERFIL_AHORRADO;
        const clientesLealesIdentificados = annualProfilesCaptured * SUPUESTOS_NEGOCIO.TASA_RECURRENCIA_BASE;

        // --- Cálculo de Rentabilidad (Ingreso Transaccional) ---
        const newPayingCustomers = annualProfilesCaptured * conversionRate;
        const ingresoPotencialAnual = newPayingCustomers * ltv;

        // --- Cálculos Financieros Clave (Proyección a 5 años) ---
        const totalIngresoProyectado = (ingresoPotencialAnual + ahorroPublicidadAnual) * 5;
        const totalOpexProyectado = totalAnnualOpex * 5;

        // El TCO es la suma de la inversión inicial y los costos operativos anuales.
        const tco = totalInitialInvestment + totalOpexProyectado;

        const beneficioNeto = totalIngresoProyectado - tco;
        
        // REPARACIÓN 2 (JS/CÁLCULO): Asegurar que Beneficio Neto sea un número válido.
        const safeBeneficioNeto = isNaN(beneficioNeto) ? 0 : beneficioNeto;

        // REPARACIÓN 3 (JS/CÁLCULO): Fórmula de Payback conservadora y lineal.
        // Payback = Inversión Inicial / (Ingreso Potencial Anual + Ahorro Publicidad Anual - Opex Anual)
        const flujoDeCajaAnual = ingresoPotencialAnual + ahorroPublicidadAnual - totalAnnualOpex;
        
        let paybackMonths = 0;
        if (flujoDeCajaAnual > 0) {
            paybackMonths = (totalInitialInvestment / flujoDeCajaAnual) * 12;
            // Limitar a 60 meses (5 años) para evitar resultados infinitos o demasiado largos
            paybackMonths = Math.min(paybackMonths, 60); 
        } else {
            // Si el flujo es negativo o cero, el payback es indefinido (ponemos un valor simbólico alto)
            paybackMonths = 99; 
        }

        let roi = 0;
        if (totalInitialInvestment > 0) {
             // ROI = (Beneficio Neto / Inversión Inicial) * 100
            roi = (safeBeneficioNeto / totalInitialInvestment) * 100;
        } else {
            // Si la inversión inicial es cero, el ROI es infinito o 0 si no hay beneficio.
            roi = safeBeneficioNeto > 0 ? 9999 : 0;
        }
        
        // --- Generación de Datos para Gráficos ---
        const cashflowData = generateCashflowData(totalInitialInvestment, flujoDeCajaAnual);
        const riskData = generateRiskData(safeBeneficioNeto, totalInitialInvestment);

        return {
            totalInitialInvestment,
            totalAnnualOpex,
            totalAps,
            ahorroPublicidadAnual,
            clientesLealesIdentificados,
            ingresoPotencialAnual,
            roi,
            paybackMonths,
            tco,
            beneficioNeto: safeBeneficioNeto,
            cashflowData,
            riskData
        };
    }

    /**
     * @brief Genera los puntos de datos para el gráfico de Flujo de Caja.
     * @param {number} initialInvestment - Inversión inicial.
     * @param {number} annualCashFlow - Flujo de caja neto anual.
     * @returns {array} Array de flujos de caja por año (5 años).
     */
    function generateCashflowData(initialInvestment, annualCashFlow) {
        let currentFlow = -initialInvestment;
        const data = [currentFlow]; // Año 0: Inversión
        for (let i = 1; i <= 5; i++) {
            currentFlow += annualCashFlow;
            data.push(currentFlow);
        }
        return data;
    }

    /**
     * @brief Simulación de Monte Carlo simplificada para el Beneficio Neto.
     * @param {number} baseNetProfit - Beneficio Neto base (centro de la distribución).
     * @param {number} initialInvestment - Inversión Inicial (usada para la variación).
     * @returns {array} Array de 500 simulaciones de Beneficio Neto.
     */
    function generateRiskData(baseNetProfit, initialInvestment) {
        const simulations = 500;
        const results = [];
        // Se asume una desviación estándar basada en el 20% de la inversión inicial (proxy de riesgo)
        const stdDev = initialInvestment * 0.20; 

        for (let i = 0; i < simulations; i++) {
            // Genera una variación aleatoria (distribución normal simulada)
            let z = 0;
            for (let j = 0; j < 12; j++) { z += Math.random() - 0.5; } // Box-Muller approx
            const variation = z * stdDev;
            
            results.push(baseNetProfit + variation);
        }
        return results.sort((a, b) => a - b);
    }

    /**
     * @brief Inicializa los listeners de los inputs y los gráficos.
     */
    function initialize() {
        // Inicializar listeners
        // NOTA v39.0: Los listeners para 'apsIndoor' y 'apsOutdoor' están correctamente incluidos aquí.
        ['apsIndoor', 'apsOutdoor', 'ltv', 'conversionRate'].forEach(id => {
            const input = document.getElementById(id);
            if (input) {
                input.addEventListener('input', updateUI);
            }
        });

        // Inicializar UI y Gráficos
        updateUI();
        initCityParkChart();
    }

    /**
     * @brief Actualiza la interfaz (KPIs y Gráficos) con los nuevos cálculos.
     */
    function updateUI() {
        const apsIndoor = parseInt(document.getElementById('apsIndoor').value) || 0;
        const apsOutdoor = parseInt(document.getElementById('apsOutdoor').value) || 0;
        const ltv = parseFloat(document.getElementById('ltv').value) || 0;
        const conversionRate = parseFloat(document.getElementById('conversionRate').value) || 0;

        // Actualizar valores de los sliders
        document.getElementById('ltvValue').textContent = `$${ltv}`;
        document.getElementById('conversionRateValue').textContent = `${(conversionRate * 100).toFixed(0)}%`;

        const data = calculate(apsIndoor, apsOutdoor, ltv, conversionRate);

        // --- 1. Actualización de KPIs ---
        // Nivel 1
        document.getElementById('kpiAhorroPublicidad').textContent = formatCurrency(data.ahorroPublicidadAnual);
        document.getElementById('kpiClientesLeales').textContent = formatNumber(data.clientesLealesIdentificados);
        document.getElementById('kpiIngresoPotencial').textContent = formatCurrency(data.ingresoPotencialAnual);

        // Nivel 2
        document.getElementById('kpiRoi').textContent = `${data.roi.toFixed(0)}%`;
        
        let paybackText = 'No aplica';
        if (data.paybackMonths < 60) {
            paybackText = `${data.paybackMonths.toFixed(1)} meses`;
        } else if (data.paybackMonths === 99) {
            paybackText = ' > 5 Años';
        } else {
             paybackText = '5+ Años';
        }
        document.getElementById('kpiPayback').textContent = paybackText;
        
        document.getElementById('kpiTco').textContent = formatCurrency(data.tco);
        document.getElementById('kpiBeneficioNeto').textContent = formatCurrency(data.beneficioNeto);
        
        // Ajustar color del Beneficio Neto
        const color = data.beneficioNeto >= 0 ? 'text-white' : 'text-red-500';
        document.getElementById('kpiBeneficioNeto').className = `text-3xl font-extrabold mt-1 ${color}`;


        // --- 2. Actualización de Gráficos ---
        updateCashflowChart(data.cashflowData);
        updateRiskChart(data.riskData, data.beneficioNeto);
    }

    /**
     * @brief Formatea un número como moneda USD.
     */
    function formatCurrency(number) {
        return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(number);
    }

    /**
     * @brief Formatea un número con separadores de miles.
     */
    function formatNumber(number) {
        return new Intl.NumberFormat('es-ES').format(number.toFixed(0));
    }

    // --- Funciones de Gráficos ---

    function updateCashflowChart(data) {
        const ctx = document.getElementById('cashflowChart').getContext('2d');
        const labels = ['Año 0 (Inv)', 'Año 1', 'Año 2', 'Año 3', 'Año 4', 'Año 5'];

        if (cashflowChartInstance) {
            cashflowChartInstance.data.datasets[0].data = data;
            cashflowChartInstance.update();
            return;
        }

        cashflowChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Flujo de Caja Acumulado (USD)',
                    data: data,
                    backgroundColor: (context) => {
                        const value = context.parsed.y;
                        return value >= 0 ? '#10B981' : '#EF4444'; // Green for positive, Red for negative
                    },
                    borderRadius: 4,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: { display: false },
                    title: { display: false }
                },
                scales: {
                    x: { ticks: { color: '#94A3B8' }, grid: { color: '#334155' } },
                    y: { ticks: { color: '#94A3B8', callback: (value) => formatCurrency(value) }, grid: { color: '#334155' } }
                }
            }
        });
    }

    function updateRiskChart(data, baseNetProfit) {
        const ctx = document.getElementById('riskChart').getContext('2d');

        if (riskChartInstance) {
            // Recalcular el histograma
            const bins = 20;
            const min = Math.min(...data);
            const max = Math.max(...data);
            const range = max - min;
            const binSize = range / bins;

            const counts = new Array(bins).fill(0);
            const labels = [];

            for (const value of data) {
                let binIndex = Math.floor((value - min) / binSize);
                if (binIndex === bins) binIndex--; // Puts the max value in the last bin
                counts[binIndex]++;
            }

            for (let i = 0; i < bins; i++) {
                labels.push(formatCurrency(min + i * binSize));
            }


            riskChartInstance.data.labels = labels;
            riskChartInstance.data.datasets[0].data = counts;
            riskChartInstance.update();
            return;
        }

        // Simulación inicial (solo se llama una vez)
        const bins = 20;
        const min = Math.min(...data);
        const max = Math.max(...data);
        const range = max - min;
        const binSize = range / bins;

        const counts = new Array(bins).fill(0);
        const labels = [];

        for (const value of data) {
            let binIndex = Math.floor((value - min) / binSize);
            if (binIndex === bins) binIndex--;
            counts[binIndex]++;
        }

        for (let i = 0; i < bins; i++) {
            labels.push(formatCurrency(min + i * binSize));
        }
        
        riskChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Frecuencia de Beneficio Neto',
                    data: counts,
                    backgroundColor: '#F97316',
                    borderColor: '#E2E8F0',
                    borderWidth: 1,
                    barPercentage: 1.0,
                    categoryPercentage: 1.0,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: { display: false },
                    title: { display: false },
                },
                scales: {
                    x: {
                        title: { display: true, text: 'Beneficio Neto Simulado (USD)', color: '#94A3B8' },
                        ticks: { color: '#94A3B8', maxRotation: 45, minRotation: 45 },
                        grid: { color: '#334155' }
                    },
                    y: {
                        title: { display: true, text: 'Nº de Simulaciones', color: '#94A3B8' },
                        ticks: { color: '#94A3B8' },
                        grid: { color: '#334155' }
                    }
                }
            }
        });
    }

    function initCityParkChart() {
        const ctx = document.getElementById('cityParkChart').getContext('2d');
        const labels = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
        
        // Datos de ejemplo simulando la tendencia
        const nuevos = [8000, 7500, 7000, 6500, 6000, 5800, 5600, 5400, 5200, 5000, 4800, 4600];
        const recurrentes = [0, 4000, 5500, 6500, 7000, 7500, 8000, 8500, 9000, 9500, 10000, 10500];

        cityParkChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Usuarios Nuevos',
                    data: nuevos,
                    backgroundColor: '#F97316', // Naranja
                }, {
                    label: 'Usuarios Recurrentes (Leales)',
                    data: recurrentes,
                    backgroundColor: '#10B981', // Verde
                }]
            },
            options: {
                responsive: true,
                scales: {
                    x: { stacked: true, ticks: { color: '#94A3B8' }, grid: { color: '#334155' } },
                    y: { stacked: true, ticks: { color: '#94A3B8', callback: (value) => formatNumber(value) }, grid: { color: '#334155' } }
                },
                plugins: {
                    legend: { labels: { color: '#E2E8F0' } },
                    title: { display: false }
                }
            }
        });
    }

    // --- Funciones Auxiliares para PDF ---
    
    /**
     * @brief Genera la estructura de datos para la tabla de KPIs del PDF.
     * @param {object} data - Resultados calculados de la simulación.
     * @returns {array} Array de arrays para jspdf-autotable. (v39.0 Hotfix)
     */
    function getKpiTableData(data) {
        return [
            ["Beneficio Neto", formatCurrency(data.beneficioNeto), "Ingresos Totales - TCO"],
            ["Retorno de Inversión (ROI)", `${data.roi.toFixed(0)}%`, `(Beneficio Neto / Inversión Inicial) x 100`],
            ["Payback (Recuperación)", data.paybackMonths < 60 ? `${data.paybackMonths.toFixed(1)} meses` : '> 5 Años', "Inversión Inicial / Flujo de Caja Anual"],
            ["TCO (Costo Total Propiedad)", formatCurrency(data.tco), "Inversión Inicial + OPEX (5 años)"],
            ["Ingreso Potencial Anual", formatCurrency(data.ingresoPotencialAnual), `Perfiles x Tasa Conversión x LTV`],
            ["Ahorro Anual Publicidad", formatCurrency(data.ahorroPublicidadAnual), `Perfiles Capturados x $0.10`]
        ];
    }
    
    /**
     * @brief REPARACIÓN 1 (JS/LÓGICA): Genera el análisis del consultor basado en los resultados.
     */
    function generateConsultantAnalysis(d) {
        const roi = d.roi;
        const paybackMonths = d.paybackMonths;
        const beneficioNeto = d.beneficioNeto;

        let analysis = "El presente análisis de rentabilidad valida la solución OhmyFi + Zoho CRM como un **Activo Estratégico** con un sólido potencial de retorno de inversión.\n\n";

        if (beneficioNeto > 0 && paybackMonths < 30) {
            analysis += "Con un **Beneficio Neto Proyectado de " + formatCurrency(beneficioNeto) + "** en 5 años y un tiempo de recuperación de la inversión (Payback) estimado en **" + paybackMonths.toFixed(1) + " meses**, la inversión se considera de bajo riesgo y alta prioridad. La capacidad de la plataforma para generar un Ahorro en Publicidad de " + formatCurrency(d.ahorroPublicidadAnual) + " anualmente actúa como un amortiguador financiero inmediato.\n\n";
            if (roi > 100) {
                 analysis += "El Retorno de Inversión (**ROI del " + d.roi.toFixed(0) + "%**) es excepcionalmente alto, indicando que el valor generado supera por mucho el Costo Total de Propiedad (TCO) de " + formatCurrency(d.tco) + ". Este desempeño supera los benchmarks de la industria para tecnologías de marketing relacional.";
            } else {
                 analysis += "El Retorno de Inversión (**ROI del " + d.roi.toFixed(0) + "%**) es positivo y saludable, confirmando que el proyecto es financieramente viable y que la estrategia de activación (LTV y Tasa de Conversión) está bien fundamentada.";
            }
        } else if (beneficioNeto > 0 && paybackMonths >= 30) {
            analysis += "El proyecto genera un **Beneficio Neto Positivo de " + formatCurrency(beneficioNeto) + " en 5 años**, lo cual es una señal de solidez. Sin embargo, con un Payback de **" + paybackMonths.toFixed(1) + " meses**, recomendamos optimizar la Tasa de Conversión y el Valor de Vida del Cliente (LTV) para acelerar la recuperación de la inversión.\n\n";
            analysis += "El principal valor radica en la **captura masiva de datos (más de " + formatNumber(d.clientesLealesIdentificados) + " perfiles anuales)**, lo que constituye un activo no monetario que mejorará el desempeño futuro del negocio.";
        } else if (beneficioNeto <= 0 && paybackMonths < 99) {
            analysis += "Aunque el Beneficio Neto Proyectado es negativo (**" + formatCurrency(beneficioNeto) + "**), la simulación de riesgo Monte Carlo indica que existe una probabilidad de generar un retorno. La inversión inicial es considerablemente alta (" + formatCurrency(d.totalInitialInvestment) + ") y requiere un ajuste en la estrategia de activación del cliente (LTV y Tasa de Conversión) para lograr el punto de equilibrio en el corto plazo. El TCO es de " + formatCurrency(d.tco) + ".";
        } else {
             // Fallback para valores extremos o no rentables (> 5 años payback)
            analysis += "La simulación indica que con los parámetros actuales (APs, LTV y Tasa de Conversión) el proyecto **no alcanza el punto de equilibrio** dentro de un horizonte de 5 años. Esto se debe a que el flujo de caja anual es bajo en relación con la inversión inicial de " + formatCurrency(d.totalInitialInvestment) + ". Recomendamos encarecidamente revisar y aumentar el **Valor de Vida del Cliente (LTV)** y la **Tasa de Conversión** para asegurar un Retorno de Inversión positivo.";
        }
        
        return analysis;
    }

    function generateFinancialStrategyText() {
        return "El modelo de OhmyFi + Zoho permite migrar costos del modelo CAPEX (Inversión de Capital) al modelo OPEX (Gasto Operativo). Al tercer año, el costo principal pasa de ser una depreciación de hardware (CAPEX) a una suscripción de software y gestión (OPEX), lo que ofrece mayor flexibilidad financiera y deducciones fiscales más favorables para la empresa.\n\n**Recomendación:** Estructurar la inversión inicial como un CAPEX y el costo recurrente de licencia y soporte como OPEX para maximizar los beneficios fiscales y el control presupuestario.";
    }

    function generatePdfVenezuelaReflection() {
        return "En el contexto económico actual de Venezuela, la base de datos propia es el activo de mayor valor. Depender de publicidad pagada es costoso e ineficiente. OhmyFi crea una base de datos 100% legal, segmentable y propietaria, blindando a su negocio contra las fluctuaciones del costo de adquisición de clientes y convirtiendo la lealtad en un flujo de caja predecible. Esto es una ventaja competitiva irremplazable.";
    }

    function generateNextStepsText() {
        return "1. **Sesión de Descubrimiento (45 min):** Agendar una reunión con un consultor de AGT para ingresar variables específicas de su negocio (costo de ticket promedio, frecuencia de compra, gasto publicitario real) y obtener una proyección ajustada.\n\n2. **Prueba de Concepto (POC):** Implementar la solución en un punto de acceso por 30 días para obtener datos reales sobre la tasa de captura de perfiles y la recurrencia de visitantes, validando la proyección de este simulador.\n\n3. **Diseño de Estrategia de Activación:** Desarrollar el *workflow* de Zoho CRM que convertirá los perfiles capturados por OhmyFi en ingresos activos.";
    }

    // --- JSDPF Core Functions (Estéticas, No Modificadas) ---
    
    // Función para generar el PDF (sin cambios estéticos)
    function generatePDF() {
        // Obtenemos los datos actuales
        const apsIndoor = parseInt(document.getElementById('apsIndoor').value) || 0;
        const apsOutdoor = parseInt(document.getElementById('apsOutdoor').value) || 0;
        const ltv = parseFloat(document.getElementById('ltv').value) || 0;
        const conversionRate = parseFloat(document.getElementById('conversionRate').value) || 0;
        const d = calculate(apsIndoor, apsOutdoor, ltv, conversionRate);
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('p', 'mm', 'a4');
        let y = 40;
        let page = 1;
        const margin = 20;
        const chartWidth = 170;
        const chartHeight = 80;
        
        // --- Helpers de Estilo (solo para PDF) ---
        const addHeader = () => {
            doc.setFont('Helvetica', 'Bold');
            doc.setFontSize(10);
            doc.setTextColor('#F97316');
            doc.text("Simulador Estratégico OhmyFi + Zoho", margin, 10);
            doc.setTextColor('#E2E8F0'); // Color de texto principal para el PDF
        };

        const addFooter = (pageNumber) => {
            doc.setFont('Helvetica', 'Normal');
            doc.setFontSize(8);
            doc.setTextColor(150, 150, 150);
            doc.text(`Página ${pageNumber} | AGT Consultores - v39.0 | Reporte generado el ${new Date().toLocaleDateString('es-ES')}`, margin, 290, { align: 'left' });
        };

        const addSectionTitle = (title) => {
            doc.setFont('Helvetica', 'Bold');
            doc.setFontSize(16);
            doc.setTextColor(255, 255, 255);
            doc.setDrawColor('#F97316');
            doc.setLineWidth(0.5);
            doc.line(margin, y + 1, margin + chartWidth, y + 1);
            doc.text(title, margin, y);
            y += 10;
        };

        const addBodyText = (text) => {
            doc.setFont('Helvetica', 'Normal');
            doc.setFontSize(10);
            doc.setTextColor(226, 232, 240);
            const splitText = doc.splitTextToSize(text, chartWidth);
            doc.text(splitText, margin, y);
            y += (splitText.length * 5) + 5;
        };
        
        // Función para agregar tabla de KPIs con estilo
        const addKpiTable = (data, title) => {
            doc.setFont('Helvetica', 'Bold');
            doc.setFontSize(14);
            doc.setTextColor('#F97316');
            doc.text(title, margin, y);
            y += 8;

            // V39.0 HOTFIX: Obtenemos el cuerpo de la tabla de la función estandarizada.
            const tableBody = getKpiTableData(data);
            const tableHead = [["KPI", "Valor Proyectado (5 Años)", "Base de Cálculo"]];
            
            doc.autoTable({
                startY: y,
                head: tableHead,
                body: tableBody,
                theme: 'striped',
                headStyles: { fillColor: '#F97316', textColor: 0, fontStyle: 'bold', fontSize: 9 },
                styles: { fontSize: 8, fillColor: '#1E293B', textColor: '#E2E8F0', cellPadding: 2, lineWidth: 0.1, lineColor: '#334155' },
                columnStyles: { 0: { fontStyle: 'bold', cellWidth: 45 }, 1: { cellWidth: 45 }, 2: { cellWidth: 80 } },
                margin: { left: margin, right: margin }
            });

            y = doc.autoTable.previous.finalY + 10;
        };

        // --- Configuración de Estilos de Fondo para PDF ---
        doc.setFillColor(15, 23, 42); // #0F172A
        doc.rect(0, 0, 210, 297, 'F'); 

        try {
            // =================================================================
            // PÁGINA 1: RESUMEN EJECUTIVO Y VALIDACIÓN DE INFRAESTRUCTURA
            // =================================================================
            addHeader();
            doc.setFont('Helvetica', 'Bold');
            doc.setFontSize(24);
            doc.setTextColor('#FFFFFF');
            doc.text("Informe de Consultoría Estratégica", margin, 25);
            doc.setFontSize(18);
            doc.setTextColor('#F97316');
            doc.text("Simulación Financiera OhmyFi + Zoho", margin, 35);

            y = 45;

            addSectionTitle("Resumen de Variables");
            addBodyText(`- Puntos de Acceso (APs) Desplegados: ${d.totalAps} (Interior: ${apsIndoor}, Exterior: ${apsOutdoor})`);
            addBodyText(`- Inversión Inicial Proyectada (TCO Inicial): ${formatCurrency(d.totalInitialInvestment)}`);
            addBodyText(`- Valor de Vida del Cliente (LTV): ${formatCurrency(ltv)}`);
            addBodyText(`- Tasa de Conversión (Perfil a Cliente): ${(conversionRate * 100).toFixed(0)}%`);
            y += 5; // Espacio extra

            addKpiTable(d, "KPIs Financieros Clave (Proyección a 5 Años)");

            addSectionTitle("Validación de Infraestructura");
            addBodyText(`La solución considera un despliegue de ${d.totalAps} APs, lo cual garantiza la cobertura adecuada para generar más de ${formatNumber(d.clientesLealesIdentificados)} perfiles leales al año y un potencial de **${formatCurrency(d.ingresoPotencialAnual)}** en ingresos activados anualmente.`);
            
            addFooter(page);
            doc.addPage();
            page++;
            addHeader();
            y = 30; // Inicio de la segunda página

            // =================================================================
            // PÁGINA 2: CASO DE ÉXITO Y GRÁFICOS
            // =================================================================
            addSectionTitle("Caso de Estudio Local: City Park Margarita");
            addBodyText("City Park validó la plataforma OhmyFi como un generador de activos. El caso demuestra cómo una estrategia de marketing relacional bien ejecutada convierte la captura de datos en un motor de crecimiento sostenido:");
            
            // Simulación de la tabla de KPIs de City Park
            doc.setFont('Helvetica', 'Bold');
            doc.setFontSize(12);
            doc.setTextColor('#F97316');
            doc.text("Resultados Validados (12 Meses):", margin, y);
            y += 6;

            const cityParkTable = [
                ["KPI", "City Park (Resultado Real)"],
                ["Perfiles Capturados", "125,000+"],
                ["Tasa de Recurrencia", "62%"],
                ["ROI Campaña Activa", "190%"]
            ];
            
            doc.autoTable({
                startY: y,
                head: [cityParkTable[0]],
                body: cityParkTable.slice(1),
                theme: 'striped',
                headStyles: { fillColor: '#2D3748', textColor: 255, fontStyle: 'bold', fontSize: 9 },
                styles: { fontSize: 8, fillColor: '#1E293B', textColor: '#E2E8F0', cellPadding: 2, lineWidth: 0.1, lineColor: '#334155' },
                columnStyles: { 0: { fontStyle: 'bold', cellWidth: 70 }, 1: { cellWidth: 100 } },
                margin: { left: margin, right: margin }
            });
            y = doc.autoTable.previous.finalY + 10;

            // Gráfico de City Park
            const cityParkChartCanvas = document.getElementById('cityParkChart');
            if (cityParkChartCanvas) {
                const chartImg = cityParkChartCanvas.toDataURL('image/png');
                addBodyText("Evolución: El gráfico de City Park demuestra cómo el número de clientes recurrentes (verde) supera y sostiene al de los nuevos (naranja) con el tiempo, probando la efectividad de la lealtad activada por Zoho.");
                doc.addImage(chartImg, 'PNG', margin, y, chartWidth, chartHeight);
                y += chartHeight + 10;
            }

            // =================================================================
            // GRÁFICOS DE LA SIMULACIÓN
            // =================================================================
            addSectionTitle("Gráfico 1: Simulación de Riesgo (Monte Carlo)");
            addBodyText("Este histograma muestra la probabilidad de ocurrencia del Beneficio Neto proyectado. La mayoría de los resultados se concentran alrededor del valor central (" + formatCurrency(d.beneficioNeto) + "), indicando que el modelo es estadísticamente estable y predecible.");
            
            const riskChartCanvas = document.getElementById('riskChart');
            if (riskChartCanvas) {
                const riskChartImg = riskChartCanvas.toDataURL('image/png');
                doc.addImage(riskChartImg, 'PNG', margin, y, chartWidth, chartHeight);
                y += chartHeight + 10;
            }
            
            // --- Force Page Break before Consultant Analysis ---
            addFooter(page);
            doc.addPage();
            page++;
            addHeader();
            y = 40; // Nueva página
            
            // Gráfico 2: Flujo de Caja Proyectado
            addSectionTitle("Gráfico 2: Flujo de Caja Proyectado (5 Años)");
            addBodyText("El flujo de caja acumulado muestra el momento exacto donde la inversión inicial se recupera (Payback) y el proyecto comienza a generar liquidez neta. Es crucial ver el punto de equilibrio (cruce del eje Y en cero).");
            
            const cashflowChartCanvas = document.getElementById('cashflowChart');
            if (cashflowChartCanvas) {
                const cashflowChartImg = cashflowChartCanvas.toDataURL('image/png');
                doc.addImage(cashflowChartImg, 'PNG', margin, y, chartWidth, chartHeight);
                y += chartHeight + 10;
            }
            
            // =================================================================
            // PÁGINA 3: ANÁLISIS DEL CONSULTOR Y PRÓXIMOS PASOS
            // =================================================================
            addSectionTitle("Análisis y Recomendación del Consultor");
            addBodyText(generateConsultantAnalysis(d));
            
            addSectionTitle("Estrategia Financiera: CAPEX vs. OPEX");
            addBodyText(generateFinancialStrategyText());
            
            addSectionTitle("Reflexión Final: Su Ventaja en Venezuela");
            addBodyText(generatePdfVenezuelaReflection());

            addSectionTitle("Próximos Pasos Recomendados");
            addBodyText(generateNextStepsText());
            
            addFooter(page);
            
            doc.save(`Reporte_Consultoria_AGT_OhmyFi_${new Date().toISOString().slice(0,10)}.pdf`);
        } catch (error) {
            console.error("Error al generar el PDF:", error);
            // NOTA: Se usa console.error en lugar de alert() como se solicitó en las directrices.
            console.log("Ocurrió un error al generar el PDF. Por favor, revise la consola para más detalles.");
        }
    }

    window.onload = function() {
        initialize();
        // Garantizar que la vista inicie en el simulador
        const simulatorEl = document.getElementById('simulator');
        if(simulatorEl) {
            simulatorEl.scrollIntoView({ behavior: 'smooth' });
        }
    };
</script>
</body>
</html>
