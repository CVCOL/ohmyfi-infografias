<!--
CONTROL DE VERSIONES: Simulador Interactivo OhmyFi
===================================================
Este bloque registra la evolución del proyecto, manteniendo un historial
de las últimas tres versiones estables para referencia rápida.

Versión: 38.4 (11/10/2025)
- Título: Hotfix Crítico: Reparación de Motor de Cálculo y Generador de PDF
- Cambios:
  1. (BUG CRÍTICO) Se reconectaron los event listeners para los campos de
     infraestructura ('aps-indoor', 'aps-outdoor') al motor de cálculo.
     La simulación es ahora 100% interactiva de nuevo.
  2. (BUG CRÍTICO) Se corrigió la estructura de datos para la tabla de KPIs
     en el PDF, solucionando el error que impedía su generación y descarga.
  3. Se actualizó el pie de página a la versión 38.4.

Versión: 38.3 (11/10/2025)
- Título: Rediseño de Layout y Refuerzo de Mensaje en PDF
- Cambios:
  1.  (PDF/DISEÑO) Se ajustó el layout de la sección "Validación" para
      evitar el solapamiento de texto e imágenes.
  2.  (PDF/CONTENIDO) Se rediseñó la sección "City Park" como un mini-caso
      de estudio de alto impacto.
  3.  (PDF/DISEÑO) Se optimizó la configuración de la tabla de KPIs para
      mejorar el ajuste automático del texto.
  4.  (PDF/DISEÑO) Se aseguró la correcta implementación del salto de página
      antes de la sección de "Análisis del Consultor".

Versión: 38.2 (11/10/2025)
- Título: Corrección Crítica de Motor de Cálculo y Formato de PDF
- Cambios:
  1.  (BUG CRÍTICO) Se reparó el motor de cálculo para que los cambios en
      la infraestructura (Nº de APs) actualicen todos los KPIs y gráficos.
  2.  (BUG PDF) Se corrigió la función de generación de datos para la
      tabla de KPIs.
-->
<!DOCTYPE html>
<html lang="es" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Infografía Interactiva: OhmyFi + Zoho CRM para PYMEs en Venezuela</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://rsms.me/">
    <link rel="stylesheet" href="https://rsms.me/inter/inter.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
        }
        .brand-gradient {
            background: linear-gradient(90deg, #4F46E5 0%, #A64AC9 100%);
        }
        .kpi-card {
            background-color: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .kpi-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .form-input {
            width: 100%;
            border-radius: 8px;
            border: 1px solid #D1D5DB;
            padding: 0.75rem 1rem;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        .form-input:focus {
            outline: none;
            border-color: #4F46E5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2);
        }
        .btn-primary {
            background-color: #4F46E5;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }
        .btn-primary:hover {
            background-color: #4338CA;
            transform: scale(1.05);
        }
        .section-title {
            font-size: 2.25rem;
            font-weight: 800;
            color: #111827;
            text-align: center;
            margin-bottom: 1rem;
        }
        .section-subtitle {
            font-size: 1.125rem;
            color: #4B5563;
            text-align: center;
            max-width: 800px;
            margin: 0 auto 3rem auto;
        }
    </style>
</head>
<body class="text-gray-800">

    <header class="bg-white shadow-md sticky top-0 z-50">
        <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
            <div class="text-2xl font-bold brand-gradient text-transparent bg-clip-text">OhmyFi + Zoho</div>
            <div class="flex items-center space-x-4">
                <span class="text-sm font-medium text-gray-600 hidden md:block">Una solución de AGT</span>
                <a href="#simulator" class="btn-primary text-sm">Ir al Simulador</a>
            </div>
        </nav>
    </header>

    <main class="container mx-auto px-6 py-12">
        <!-- Hero Section -->
        <section class="text-center mb-24">
            <h1 class="text-5xl md:text-6xl font-extrabold mb-4 text-gray-900 leading-tight">Su Wi-Fi de Invitados no es un Gasto.</h1>
            <h2 class="text-5xl md:text-6xl font-extrabold brand-gradient text-transparent bg-clip-text mb-6">Es un Activo Estratégico.</h2>
            <p class="section-subtitle">Descubra cómo la solución "OhmyFi + Zoho CRM" implementada por AGT convierte cada conexión a su red Wi-Fi en una oportunidad de negocio medible y rentable para su PYME en Venezuela.</p>
        </section>

        <!-- Process Section -->
        <section class="mb-24">
            <h2 class="section-title">De Conexión a Conversión en 4 Pasos</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8">
                <!-- Step 1 -->
                <div class="text-center p-6 bg-white rounded-xl shadow-lg">
                    <div class="text-4xl font-bold brand-gradient text-transparent bg-clip-text mb-2">1</div>
                    <h3 class="text-lg font-bold mb-2">Captura de Datos</h3>
                    <p class="text-gray-600 text-sm">El cliente se conecta a su red Wi-Fi a través de un portal cautivo simple, proporcionando datos valiosos (nombre, email, teléfono) que se integran automáticamente en Zoho CRM.</p>
                </div>
                <!-- Step 2 -->
                <div class="text-center p-6 bg-white rounded-xl shadow-lg">
                    <div class="text-4xl font-bold brand-gradient text-transparent bg-clip-text mb-2">2</div>
                    <h3 class="text-lg font-bold mb-2">Inteligencia de Negocio</h3>
                    <p class="text-gray-600 text-sm">OhmyFi analiza el comportamiento del cliente: ¿cuándo viene?, ¿con qué frecuencia?, ¿cuánto tiempo se queda? Estos datos enriquecen el perfil del cliente en Zoho CRM.</p>
                </div>
                <!-- Step 3 -->
                <div class="text-center p-6 bg-white rounded-xl shadow-lg">
                    <div class="text-4xl font-bold brand-gradient text-transparent bg-clip-text mb-2">3</div>
                    <h3 class="text-lg font-bold mb-2">Marketing Automatizado</h3>
                    <p class="text-gray-600 text-sm">Con Zoho CRM, se ejecutan campañas de marketing automatizadas y personalizadas: cupones, encuestas de satisfacción, promociones especiales para clientes recurrentes.</p>
                </div>
                <!-- Step 4 -->
                <div class="text-center p-6 bg-white rounded-xl shadow-lg">
                    <div class="text-4xl font-bold brand-gradient text-transparent bg-clip-text mb-2">4</div>
                    <h3 class="text-lg font-bold mb-2">Medición y Venta</h3>
                    <p class="text-gray-600 text-sm">Medimos el impacto real de las campañas en las ventas. El ciclo se cierra cuando el cliente regresa y compra, demostrando el ROI directo de su red Wi-Fi.</p>
                </div>
            </div>
        </section>
        
        <!-- Validation Section: City Park Case Study -->
        <section class="mb-24 bg-white rounded-2xl p-8 shadow-2xl">
            <h2 class="section-title">Validación: La Prueba en el Mundo Real</h2>
            <p class="section-subtitle">Para demostrar el poder de esta estrategia, realizamos una prueba controlada en "City Park", un concurrido parque de food trucks en Lechería, Anzoátegui. Con solo 2 puntos de acceso, los resultados en un período de 90 días fueron contundentes.</p>
            
             <div class="grid grid-cols-1 lg:grid-cols-5 gap-8 items-center">
                <!-- KPIs -->
                <div class="lg:col-span-2 space-y-4">
                    <div class="kpi-card text-center">
                        <p class="text-lg text-gray-500">Conexiones Totales</p>
                        <p class="text-5xl font-bold text-indigo-600">3,731</p>
                    </div>
                    <div class="kpi-card text-center">
                        <p class="text-lg text-gray-500">Nuevos Clientes Captados</p>
                        <p class="text-5xl font-bold text-indigo-600">2,551</p>
                    </div>
                     <div class="kpi-card text-center">
                        <p class="text-lg text-gray-500">Tasa de Recurrencia</p>
                        <p class="text-5xl font-bold text-indigo-600">31.6%</p>
                    </div>
                </div>
                
                <!-- Charts -->
                <div class="lg:col-span-3">
                    <div class="bg-gray-50 p-6 rounded-xl">
                        <h3 class="text-xl font-bold text-center mb-4">Evolución de Clientes (90 Días)</h3>
                        <canvas id="cityParkEvolutionChart"></canvas>
                    </div>
                    <div class="bg-gray-50 p-6 rounded-xl mt-6">
                        <h3 class="text-xl font-bold text-center mb-4">Patrones de Visita Semanal (Ilustrativo)</h3>
                        <canvas id="cityParkWeeklyChart"></canvas>
                    </div>
                </div>
            </div>
            
             <div class="mt-12 bg-indigo-50 border-l-4 border-indigo-500 p-6 rounded-r-lg">
                <h3 class="text-xl font-bold text-gray-800">El Retorno de la Inversión (ROI) del Caso de Estudio</h3>
                <p class="text-gray-700 mt-2">Aplicando supuestos conservadores (Valor de Cliente de $25 y una Tasa de Conversión de solo 5%), la inversión en City Park generó un <strong class="text-indigo-700 font-bold text-2xl">ROI del 667%</strong>. Esto no es una proyección; es la demostración de que transformar el Wi-Fi en un activo es una de las inversiones más rentables para una PYME en Venezuela hoy.</p>
            </div>
        </section>

        <!-- Simulator Section -->
        <section id="simulator" class="mb-12">
            <div class="bg-white rounded-2xl p-8 md:p-12 shadow-2xl">
                <h2 class="section-title">Simule el Potencial para SU Negocio</h2>
                <p class="section-subtitle">Ajuste los parámetros según la realidad de su empresa y observe en tiempo real cómo su red Wi-Fi se convierte en un motor de crecimiento.</p>

                <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                    <!-- Form -->
                    <div class="lg:col-span-4 bg-gray-50 p-6 rounded-xl border">
                        <h3 class="text-xl font-bold mb-6">1. Parámetros de su Negocio</h3>
                        
                        <!-- Infraestructura -->
                        <div class="mb-4">
                            <label class="font-semibold text-gray-700 block mb-2">Infraestructura Wi-Fi (APs)</label>
                            <div class="flex items-center space-x-4">
                                <div class="flex-1">
                                    <label for="aps-indoor" class="text-sm text-gray-500">Nº de APs Interiores</label>
                                    <input type="number" id="aps-indoor" value="2" min="0" class="form-input">
                                </div>
                                <div class="flex-1">
                                    <label for="aps-outdoor" class="text-sm text-gray-500">Nº de APs Exteriores</label>
                                    <input type="number" id="aps-outdoor" value="0" min="0" class="form-input">
                                </div>
                            </div>
                        </div>

                        <!-- LTV -->
                        <div class="mb-4">
                            <label for="ltv" class="font-semibold text-gray-700 block mb-1">Valor de Vida del Cliente (LTV)</label>
                            <p class="text-xs text-gray-500 mb-2">¿Cuánto gasta un cliente leal en su negocio durante un año?</p>
                            <div class="relative">
                                <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500">$</span>
                                <input type="number" id="ltv" value="50" min="1" class="form-input pl-7">
                            </div>
                        </div>
                        
                        <!-- Conversion Rate -->
                        <div class="mb-4">
                            <label for="conversion-rate" class="font-semibold text-gray-700 block mb-1">Tasa de Conversión a Cliente (%)</label>
                            <p class="text-xs text-gray-500 mb-2">De 100 personas que reciben un cupón, ¿cuántas regresan a comprar?</p>
                            <input type="range" id="conversion-rate" min="1" max="20" value="5" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                            <div class="text-center font-bold text-indigo-600 mt-1" id="conversion-rate-value">5%</div>
                        </div>

                        <div class="mt-8 text-center">
                            <button id="generate-pdf-btn" class="btn-primary w-full">Generar Reporte en PDF</button>
                        </div>
                    </div>

                    <!-- Dashboard -->
                    <div class="lg:col-span-8">
                        <h3 class="text-xl font-bold mb-6 text-center lg:text-left">2. Dashboard de Proyección de Resultados</h3>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                            <!-- KPIs -->
                            <div class="kpi-card text-center"><p class="text-gray-500">Clientes Potenciales / Mes</p><p id="kpi-leads" class="text-3xl font-bold text-indigo-600">0</p></div>
                            <div class="kpi-card text-center"><p class="text-gray-500">ROI Proyectado</p><p id="kpi-roi" class="text-3xl font-bold text-indigo-600">0%</p></div>
                            <div class="kpi-card text-center"><p class="text-gray-500">Ingresos Adicionales / Mes</p><p id="kpi-revenue" class="text-3xl font-bold text-indigo-600">$0</p></div>
                            <div class="kpi-card text-center"><p class="text-gray-500">Costo Adquisición Cliente (CAC)</p><p id="kpi-cac" class="text-3xl font-bold text-indigo-600">$0</p></div>
                            <div class="kpi-card text-center"><p class="text-gray-500">Punto de Equilibrio</p><p id="kpi-breakeven" class="text-3xl font-bold text-indigo-600">0 meses</p></div>
                            <div class="kpi-card text-center"><p class="text-gray-500">Inversión Inicial (CAPEX)</p><p id="kpi-capex" class="text-3xl font-bold text-indigo-600">$0</p></div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                            <div class="bg-gray-50 p-4 rounded-xl">
                                <h4 class="font-bold text-center mb-2">Proyección de Ingresos vs. Costos (12 Meses)</h4>
                                <canvas id="revenueChart"></canvas>
                            </div>
                            <div class="bg-gray-50 p-4 rounded-xl">
                               <h4 class="font-bold text-center mb-2">Flujo de Caja Acumulado (12 Meses)</h4>
                                <canvas id="cashflowChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>
    
    <footer class="bg-gray-800 text-white text-center py-4">
        <p>&copy; 2025 AGT - Soluciones Tecnológicas. Todos los derechos reservados.</p>
        <p class="text-xs text-gray-400">Versión 38.4</p>
    </footer>

<script>
    let revenueChart, cashflowChart, cityParkEvolutionChart, cityParkWeeklyChart;
    let lastCalculationData = null;

    const CURRENCY_FORMATTER = new Intl.NumberFormat('es-VE', { style: 'currency', currency: 'USD', minimumFractionDigits: 0, maximumFractionDigits: 0 });
    const NUMBER_FORMATTER = new Intl.NumberFormat('es-VE', { minimumFractionDigits: 0, maximumFractionDigits: 0 });

    const CONFIG = {
        // Costos de Hardware (CAPEX)
        costPerApIndoor: 150, // Costo por Access Point interior
        costPerApOutdoor: 350, // Costo por Access Point exterior
        installationFeePercentage: 0.20, // 20% del costo de hardware

        // Costos Operativos (OPEX) Mensuales
        ohmyfiLicensePerAp: 15, // Licencia mensual por AP
        zohocrmLicense: 50, // Licencia mensual fija de Zoho CRM
        agtSupportFee: 75, // Soporte mensual fijo de AGT

        // Métricas de Rendimiento
        connectionsPerApIndoor: 450, // Conexiones mensuales por AP interior
        connectionsPerApOutdoor: 600, // Conexiones mensuales por AP exterior
        newUserRate: 0.7, // 70% de las conexiones son de nuevos usuarios
    };

    function calculate() {
        const apsIndoor = parseInt(document.getElementById('aps-indoor').value) || 0;
        const apsOutdoor = parseInt(document.getElementById('aps-outdoor').value) || 0;
        const ltv = parseFloat(document.getElementById('ltv').value) || 0;
        const conversionRate = parseFloat(document.getElementById('conversion-rate').value) / 100;

        // CAPEX (Inversión Inicial)
        const hardwareCost = (apsIndoor * CONFIG.costPerApIndoor) + (apsOutdoor * CONFIG.costPerApOutdoor);
        const installationCost = hardwareCost * CONFIG.installationFeePercentage;
        const capex = hardwareCost + installationCost;

        // OPEX (Costo Mensual)
        const totalAps = apsIndoor + apsOutdoor;
        const opex = (totalAps * CONFIG.ohmyfiLicensePerAp) + CONFIG.zohocrmLicense + CONFIG.agtSupportFee;

        // Generación de Leads
        const totalConnections = (apsIndoor * CONFIG.connectionsPerApIndoor) + (apsOutdoor * CONFIG.connectionsPerApOutdoor);
        const leads = totalConnections * CONFIG.newUserRate;
        const customers = leads * conversionRate;
        
        // Métricas Financieras
        const monthlyRevenue = customers * ltv;
        const monthlyProfit = monthlyRevenue - opex;
        const cac = totalAps > 0 ? opex / customers : 0;
        const roi = capex > 0 ? ((monthlyProfit * 12) - capex) / capex * 100 : 0;
        const breakevenMonths = monthlyProfit > 0 ? capex / monthlyProfit : 0;
        
        lastCalculationData = {
            apsIndoor, apsOutdoor, ltv, conversionRate, capex, opex, leads, customers,
            monthlyRevenue, monthlyProfit, cac, roi, breakevenMonths
        };
        
        updateDashboard(lastCalculationData);
        return lastCalculationData;
    }

    function updateDashboard(d) {
        document.getElementById('kpi-leads').textContent = NUMBER_FORMATTER.format(d.leads);
        document.getElementById('kpi-roi').textContent = `${NUMBER_FORMATTER.format(d.roi)}%`;
        document.getElementById('kpi-revenue').textContent = CURRENCY_FORMATTER.format(d.monthlyRevenue);
        document.getElementById('kpi-cac').textContent = CURRENCY_FORMATTER.format(d.cac);
        document.getElementById('kpi-breakeven').textContent = `${d.breakevenMonths > 0 ? d.breakevenMonths.toFixed(1) : 'N/A'} meses`;
        document.getElementById('kpi-capex').textContent = CURRENCY_FORMATTER.format(d.capex);
        
        updateCharts(d);
    }

    function updateCharts(d) {
        const months = Array.from({ length: 12 }, (_, i) => `Mes ${i + 1}`);
        const revenueData = Array(12).fill(d.monthlyRevenue);
        const costData = Array(12).fill(d.opex);
        
        let cumulativeCashflow = -d.capex;
        const cashflowData = months.map(() => {
            cumulativeCashflow += d.monthlyProfit;
            return cumulativeCashflow;
        });

        // Revenue Chart
        revenueChart.data.labels = months;
        revenueChart.data.datasets[0].data = revenueData;
        revenueChart.data.datasets[1].data = costData;
        revenueChart.update();

        // Cashflow Chart
        cashflowChart.data.labels = months;
        cashflowChart.data.datasets[0].data = cashflowData;
        cashflowChart.update();
    }
    
    function createCharts() {
        const defaultData = { monthlyRevenue: 0, opex: 0, capex: 0, monthlyProfit: 0 };
        const months = Array.from({ length: 12 }, (_, i) => `Mes ${i + 1}`);
        const revenueData = Array(12).fill(defaultData.monthlyRevenue);
        const costData = Array(12).fill(defaultData.opex);
        let cumulativeCashflow = -defaultData.capex;
        const cashflowData = months.map(() => {
            cumulativeCashflow += defaultData.monthlyProfit;
            return cumulativeCashflow;
        });

        const chartOptions = {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { beginAtZero: true }
            },
            plugins: { legend: { position: 'top' } }
        };
        
        // Revenue Chart
        const revenueCtx = document.getElementById('revenueChart').getContext('2d');
        revenueChart = new Chart(revenueCtx, {
            type: 'bar',
            data: {
                labels: months,
                datasets: [
                    { label: 'Ingresos', data: revenueData, backgroundColor: 'rgba(79, 70, 229, 0.7)' },
                    { label: 'Costos (OPEX)', data: costData, backgroundColor: 'rgba(255, 99, 132, 0.7)' }
                ]
            },
            options: chartOptions
        });
        
        // Cashflow Chart
        const cashflowCtx = document.getElementById('cashflowChart').getContext('2d');
        cashflowChart = new Chart(cashflowCtx, {
            type: 'line',
            data: {
                labels: months,
                datasets: [{
                    label: 'Flujo de Caja Acumulado',
                    data: cashflowData,
                    borderColor: 'rgba(34, 197, 94, 1)',
                    backgroundColor: 'rgba(34, 197, 94, 0.1)',
                    fill: true,
                    tension: 0.3
                }]
            },
            options: chartOptions
        });
        
        // City Park Evolution Chart
        const cityParkEvolutionCtx = document.getElementById('cityParkEvolutionChart').getContext('2d');
        cityParkEvolutionChart = new Chart(cityParkEvolutionCtx, {
            type: 'bar',
            data: {
                labels: ['Mes 1', 'Mes 2', 'Mes 3'],
                datasets: [
                    { label: 'Nuevos Clientes', data: [800, 851, 900], backgroundColor: '#4F46E5' },
                    { label: 'Clientes Recurrentes', data: [350, 405, 425], backgroundColor: '#A64AC9' }
                ]
            },
            options: { ...chartOptions, scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true } } }
        });

        // City Park Weekly Chart
        const cityParkWeeklyCtx = document.getElementById('cityParkWeeklyChart').getContext('2d');
        cityParkWeeklyChart = new Chart(cityParkWeeklyCtx, {
            type: 'radar',
            data: {
                labels: ['Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado', 'Domingo'],
                datasets: [{
                    label: 'Tráfico Promedio',
                    data: [20, 30, 45, 60, 85, 95, 75],
                    fill: true,
                    backgroundColor: 'rgba(79, 70, 229, 0.2)',
                    borderColor: 'rgb(79, 70, 229)',
                    pointBackgroundColor: 'rgb(79, 70, 229)',
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                elements: { line: { tension: 0.1 } },
                scales: { r: { suggestedMin: 0 } }
            }
        });
    }

    function initialize() {
        createCharts();
        
        const conversionRateSlider = document.getElementById('conversion-rate');
        const conversionRateValue = document.getElementById('conversion-rate-value');
        conversionRateSlider.addEventListener('input', (event) => {
            conversionRateValue.textContent = `${event.target.value}%`;
            calculate();
        });
        
        document.getElementById('ltv').addEventListener('input', calculate);
        document.getElementById('generate-pdf-btn').addEventListener('click', generatePdf);
        
        // HOTFIX v38.4: Re-added the missing event listeners for infrastructure inputs.
        document.getElementById('aps-indoor').addEventListener('input', calculate);
        document.getElementById('aps-outdoor').addEventListener('input', calculate);

        calculate();
    }
    
    // --- PDF Generation Functions ---
    
    // HOTFIX v38.4: This function now returns a correctly formatted Array of Arrays
    // for jspdf-autotable, fixing the critical PDF generation bug.
    function generatePdfKpiExplanations(d) {
        return [
            ['Clientes Potenciales (Leads)', `Con una tasa de conversión del ${(d.conversionRate * 100).toFixed(1)}%, su red Wi-Fi puede generar aproximadamente ${Math.round(d.leads).toLocaleString('es-VE')} clientes potenciales calificados cada mes.`],
            ['Retorno de la Inversión (ROI)', `El ROI proyectado es del ${Math.round(d.roi).toLocaleString('es-VE')}%. Esto significa que por cada dólar invertido en la solución, se genera un retorno significativo, validando la rentabilidad del proyecto.`],
            ['Ingresos Mensuales Adicionales', `Se proyecta un ingreso mensual adicional de $${d.monthlyRevenue.toLocaleString('es-VE', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} reinvirtiendo una fracción de los ingresos en marketing digital.`],
            ['Costo de Adquisición de Cliente (CAC)', `El CAC a través de esta estrategia se estima en $${d.cac.toLocaleString('es-VE', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}, una cifra altamente competitiva en el mercado venezolano.`],
            ['Valor del Cliente (LTV)', `Cada nuevo cliente adquirido a través del Wi-Fi tiene un valor de vida estimado de $${d.ltv.toLocaleString('es-VE', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}, lo que demuestra la importancia de la retención.`],
            ['Punto de Equilibrio (Breakeven)', `La inversión inicial en la infraestructura y el servicio se recuperaría en aproximadamente ${d.breakevenMonths.toFixed(1)} meses, un plazo muy corto para una inversión tecnológica.`]
        ];
    }
    
    function generateConsultantAnalysis(d) {
        return `Basado en los parámetros proporcionados, la implementación de la solución OhmyFi + Zoho CRM presenta una oportunidad de alto impacto para su negocio. El costo de adquisición de clientes (CAC) de $${d.cac.toFixed(2)} es notablemente bajo, y un punto de equilibrio en aproximadamente ${d.breakevenMonths.toFixed(1)} meses indica una rápida recuperación de la inversión. La clave del éxito radicará en capitalizar los ${Math.round(d.leads)} leads mensuales con estrategias de marketing efectivas, apalancadas en el LTV de $${d.ltv.toFixed(2)} por cliente.`;
    }

    function generateFinancialStrategyText() {
        return "La inversión se divide en CAPEX (inversión inicial en hardware e instalación) y OPEX (costos operativos mensuales de licencias y soporte). Nuestro modelo demuestra que los ingresos adicionales generados superan rápidamente el OPEX, convirtiendo un costo operativo tradicional (como el Wi-Fi) en un centro de beneficios que financia su propio crecimiento.";
    }
    
    function generatePdfVenezuelaReflection() {
        return "En el contexto económico venezolano, la capacidad de generar nuevos clientes de forma medible y rentable es una ventaja competitiva decisiva. Esta solución no solo optimiza un recurso existente (su red Wi-Fi), sino que lo convierte en un motor predecible de crecimiento, permitiéndole tomar decisiones de negocio basadas en datos reales y no en suposiciones.";
    }

    function generateNextStepsText() {
        return "1. Agendar una reunión de diagnóstico con un especialista de AGT.\n2. Realizar un levantamiento técnico (Site Survey) de sus instalaciones.\n3. Presentar una propuesta comercial detallada y personalizada.";
    }

    async function generatePdf() {
        if (!lastCalculationData) {
            alert("Por favor, realice una simulación primero.");
            return;
        }

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const d = lastCalculationData;

        try {
            const margin = 15;
            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();
            let y = 40;
            let page = 1;

            const addHeader = () => {
                doc.setFont("helvetica", "bold");
                doc.setFontSize(16);
                doc.text("Reporte de Consultoría Estratégica", pageWidth / 2, 20, { align: "center" });
                doc.setFontSize(10);
                doc.text("OhmyFi + Zoho CRM para PYMEs", pageWidth / 2, 28, { align: "center" });
            };
            
            const addFooter = (pageNum) => {
                doc.setFont("helvetica", "normal");
                doc.setFontSize(8);
                doc.text(`Página ${pageNum}`, pageWidth / 2, pageHeight - 10, { align: "center" });
                doc.text(`© 2025 AGT - Soluciones Tecnológicas | v38.4`, pageWidth - margin, pageHeight - 10, { align: 'right' });
            };
            
            const addSectionTitle = (title) => {
                doc.setFont("helvetica", "bold");
                doc.setFontSize(12);
                doc.text(title, margin, y);
                y += 8;
            };

            const addBodyText = (text) => {
                doc.setFont("helvetica", "normal");
                doc.setFontSize(10);
                const splitText = doc.splitTextToSize(text, pageWidth - margin * 2);
                doc.text(splitText, margin, y);
                y += (splitText.length * 5) + 8;
            };
            
            // --- PAGE 1 ---
            addHeader();
            
            addSectionTitle("Resumen Ejecutivo de la Simulación");
            addBodyText(`Este reporte analiza el potencial de convertir su infraestructura Wi-Fi en un activo de generación de ingresos, basado en los parámetros específicos de su negocio.`);
            
            addSectionTitle("Parámetros Utilizados en la Simulación");
            doc.autoTable({
                startY: y,
                theme: 'grid',
                head: [['Parámetro', 'Valor']],
                body: [
                    ['Nº APs Interiores', d.apsIndoor],
                    ['Nº APs Exteriores', d.apsOutdoor],
                    ['Valor de Vida del Cliente (LTV)', CURRENCY_FORMATTER.format(d.ltv)],
                    ['Tasa de Conversión', `${(d.conversionRate * 100).toFixed(1)}%`]
                ]
            });
            y = doc.autoTable.previous.finalY + 10;
            
            addSectionTitle("Análisis de Métricas Clave (KPIs)");
            doc.autoTable({
                startY: y,
                theme: 'striped',
                head: [['Métrica Clave (KPI)', 'Análisis y Explicación en el Contexto de su Negocio']],
                body: generatePdfKpiExplanations(d), // This now receives correctly formatted data
                headStyles: { fillColor: [79, 70, 229] },
                didDrawPage: (data) => {
                    addFooter(page);
                    if(data.pageNumber > 1) { page++; addHeader(); }
                }
            });
            y = doc.autoTable.previous.finalY + 10;
            
            addFooter(page);

            // --- PAGE 2 ---
            doc.addPage();
            page++;
            addHeader();
            y = 40;

            addSectionTitle("Proyecciones Gráficas (Próximos 12 Meses)");
            const chartOptions = { scale: 2, animation: { duration: 0 } };
            const revenueChartImg = revenueChart.toBase64Image('image/png', 1.0);
            const cashflowChartImg = cashflowChart.toBase64Image('image/png', 1.0);
            
            const chartWidth = pageWidth - margin * 2;
            const chartHeight = (chartWidth / 16) * 9;

            if (y + chartHeight < pageHeight - 20) {
                doc.addImage(revenueChartImg, 'PNG', margin, y, chartWidth, chartHeight);
                y += chartHeight + 10;
            }
            if (y + chartHeight < pageHeight - 20) {
                 doc.text("Flujo de Caja Acumulado", margin, y);
                 y += 5;
                doc.addImage(cashflowChartImg, 'PNG', margin, y, chartWidth, chartHeight);
                y += chartHeight + 10;
            }
            
            addFooter(page);
            doc.addPage();
            page++;
            addHeader();
            y = 40;

            addSectionTitle("Análisis y Recomendación del Consultor");
            addBodyText(generateConsultantAnalysis(d));
            
            addSectionTitle("Estrategia Financiera: CAPEX vs. OPEX");
            addBodyText(generateFinancialStrategyText());
            
            addSectionTitle("Reflexión Final: Su Ventaja en Venezuela");
            addBodyText(generatePdfVenezuelaReflection());

            addSectionTitle("Próximos Pasos Recomendados");
            addBodyText(generateNextStepsText());
            
            addFooter(page);
            
            doc.save(`Reporte_Consultoria_AGT_OhmyFi_${new Date().toISOString().slice(0,10)}.pdf`);
        } catch (error) {
            console.error("Error al generar el PDF:", error);
            alert("Ocurrió un error al generar el PDF. Por favor, revise la consola para más detalles.");
        }
    }

    window.onload = function() {
        initialize();
        const simulatorEl = document.getElementById('simulator');
        if(simulatorEl) {
            simulatorEl.scrollIntoView({ behavior: 'smooth' });
        }
    };
</script>
</body>
</html>
