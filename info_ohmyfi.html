<!--
CONTROL DE VERSIONES
=====================
Versión: 16.9 (08/10/2025)
- PDF de Consultoría Inteligente: Se rediseñó la exportación a PDF. Ahora incluye un "Análisis y Recomendación del Consultor" en lenguaje natural que interpreta los resultados de la simulación y ofrece una recomendación estratégica profesional basada en los KPIs.
- Interactividad Reparada: Se corrigió el error que impedía activar el giro 3D en los gráficos al hacer clic en el ícono de información. La funcionalidad ha sido restaurada.
- Potenciación Visual: Se reemplazaron todas las imágenes de marcador de posición con las imágenes profesionales proporcionadas, mejorando significativamente el aspecto de la cabecera y el simulador.

Versión: 16.8 (08/10/2025)
- Inteligencia de Negocio Mejorada: Se enriqueció la cara reversa de todos los gráficos. Ahora incluyen un "Racional Funcional" en lenguaje de negocios para explicar el impacto de cada métrica, además de la "Memoria de Cálculo" con los valores de la simulación.

Versión: 16.7 (08/10/2025)
- Dashboard de KPIs Avanzado: Se expandió la sección de KPIs a 6 métricas clave (ROI, TCO, Payback, CAPEX, OPEX, Beneficio Neto), organizadas en una cuadrícula de 2x3.
- Interactividad 3D Total: Se implementó efecto de giro 3D en todas las tarjetas de KPI (al pasar el mouse) y en todos los gráficos (al hacer clic en el ícono de info) para mostrar análisis contextuales.
-->
<!DOCTYPE html>
<html lang="es" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Análisis Interactivo de Valor: OhmyFi + Zoho en Venezuela</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --agt-dark: #0F172A; /* Slate 900 */
            --agt-blue: #1E3A8A; /* Indigo 800 */
            --agt-orange: #F97316; /* Orange 500 */
            --agt-light-gray: #F1F5F9; /* Slate 100 */
            --agt-text: #E2E8F0; /* Slate 200 */
        }
        body { 
            font-family: 'Inter', sans-serif;
            background-color: var(--agt-dark);
            color: var(--agt-text);
        }
        .section-title {
            font-size: 2.25rem;
            font-weight: 800;
            line-height: 1.2;
            text-align: center;
            margin-bottom: 1rem;
        }
        .section-subtitle {
            font-size: 1.125rem;
            text-align: center;
            color: #94a3b8; /* Slate 400 */
            max-width: 800px;
            margin: 0 auto 3rem auto;
        }
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.3s ease;
            cursor: pointer;
            border: 2px solid transparent;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .btn-primary {
            background-color: var(--agt-orange);
            color: white;
        }
        .btn-primary:hover {
            background-color: #FB923C; /* Orange 400 */
        }
        .btn-secondary {
            background-color: #334155; /* Slate 700 */
            color: var(--agt-text);
        }
        .btn-secondary:hover {
             background-color: #475569; /* Slate 600 */
        }
        .btn-active {
            background-color: var(--agt-orange);
            color: white;
            box-shadow: 0 0 15px rgba(249, 115, 22, 0.5);
        }
        .card {
            background-color: #1E293B; /* Slate 800 */
            border-radius: 0.75rem;
            padding: 1.5rem;
            border: 1px solid #334155; /* Slate 700 */
            height: 100%;
        }

        /* 3D Flip Card Styles */
        .flip-card {
            background-color: transparent;
            width: 100%;
            perspective: 1000px;
            min-height: 220px; /* SOLUCIÓN: Restablecer altura mínima para tarjetas de info */
        }
        .kpi-flip-card {
             min-height: 180px;
        }
        .chart-flip-card {
            height: 400px; /* Altura reducida para móviles (Mobile-first) */
        }
        .flip-card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            text-align: left;
            transition: transform 0.8s;
            transform-style: preserve-3d;
        }
        
        /* HOVER flip for KPI cards */
        .hover-flip-card:hover .flip-card-inner {
            transform: rotateY(180deg);
        }

        /* CLICK flip for chart cards */
        .chart-flip-card.is-flipped .flip-card-inner {
            transform: rotateY(180deg);
        }

        .flip-card-front, .flip-card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            -webkit-backface-visibility: hidden; /* Safari */
            backface-visibility: hidden;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-color: #1E293B; /* Slate 800 */
            border-radius: 0.75rem;
            border: 1px solid #334155; /* Slate 700 */
            padding: 1.5rem;
        }
        .flip-card-back {
            transform: rotateY(180deg);
            align-items: flex-start;
        }
        .flip-trigger {
            position: absolute;
            top: 15px;
            right: 15px;
            cursor: pointer;
            z-index: 10;
            color: #94a3b8;
            transition: color 0.3s;
        }
        .flip-trigger:hover {
            color: var(--agt-orange);
        }
        @media (min-width: 768px) {
            .chart-flip-card {
                height: 450px; /* Altura original para pantallas medianas y grandes */
            }
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto">

        <!-- HEADER -->
        <header class="mb-16 text-center">
            <img src="https://i.imgur.com/YjSq4q3.png" 
                 alt="Equipo de profesionales analizando datos en un entorno tecnológico"
                 class="w-full h-64 md:h-96 object-cover rounded-xl mb-8 opacity-75">
            <h1 class="text-4xl md:text-6xl font-extrabold mb-4 leading-tight">
                Transforme su Wi-Fi de un <span class="text-red-400">Gasto</span> a un <span class="text-green-400">Activo Estratégico</span>
            </h1>
            <p class="section-subtitle">Descubra cómo la solución OhmyFi + Zoho CRM, implementada por AGT, convierte su red de invitados en un motor de inteligencia de negocios y crecimiento para el mercado venezolano.</p>
        </header>

        <!-- DATA JOURNEY SECTION -->
        <section class="mb-20">
            <h2 class="section-title">El Viaje del Dato: De Conexión a Conversión</h2>
            <p class="section-subtitle">Visualice el flujo de valor. Así es como convertimos una simple conexión Wi-Fi en una relación rentable y medible con sus clientes.</p>
            <div class="grid grid-cols-1 md:grid-cols-5 gap-6 relative">
                
                <div class="flip-card hover-flip-card">
                    <div class="flip-card-inner">
                        <div class="flip-card-front card text-center">
                             <i data-lucide="wifi" class="w-12 h-12 mb-4 text-orange-500 mx-auto"></i>
                             <h3 class="font-bold text-lg mb-2">1. Conexión</h3>
                             <p class="text-sm text-slate-400">El cliente se conecta al Wi-Fi gratuito a través de un portal cautivo personalizado.</p>
                        </div>
                        <div class="flip-card-back text-center">
                             <h3 class="font-bold text-lg mb-2 text-orange-400">Portal de Marca</h3>
                             <p class="text-sm text-slate-300">El primer contacto es clave. Creamos un portal de acceso con su identidad de marca que ofrece una experiencia de conexión segura y profesional.</p>
                        </div>
                    </div>
                </div>
                <div class="flip-card hover-flip-card">
                    <div class="flip-card-inner">
                        <div class="flip-card-front card text-center">
                            <i data-lucide="database" class="w-12 h-12 mb-4 text-orange-500 mx-auto"></i>
                            <h3 class="font-bold text-lg mb-2">2. Captura</h3>
                            <p class="text-sm text-slate-400">Se capturan datos de primera mano (First-Party Data) con consentimiento explícito.</p>
                        </div>
                        <div class="flip-card-back text-center">
                            <h3 class="font-bold text-lg mb-2 text-orange-400">Activo de Datos</h3>
                            <p class="text-sm text-slate-300">Los "First-Party Data" son su activo más valioso: precisos, relevantes y obtenidos con consentimiento para una personalización efectiva y legal.</p>
                        </div>
                    </div>
                </div>
                <div class="flip-card hover-flip-card">
                    <div class="flip-card-inner">
                        <div class="flip-card-front card text-center">
                            <i data-lucide="users" class="w-12 h-12 mb-4 text-orange-500 mx-auto"></i>
                            <h3 class="font-bold text-lg mb-2">3. Perfilamiento</h3>
                            <p class="text-sm text-slate-400">El perfil del cliente se crea o actualiza automáticamente en Zoho CRM.</p>
                        </div>
                         <div class="flip-card-back text-center">
                            <h3 class="font-bold text-lg mb-2 text-orange-400">Inteligencia 360°</h3>
                            <p class="text-sm text-slate-300">La integración nativa con Zoho CRM enriquece el perfil del cliente, unificando su comportamiento online y offline para una visión completa.</p>
                        </div>
                    </div>
                </div>
                 <div class="flip-card hover-flip-card">
                    <div class="flip-card-inner">
                        <div class="flip-card-front card text-center">
                            <i data-lucide="send" class="w-12 h-12 mb-4 text-orange-500 mx-auto"></i>
                            <h3 class="font-bold text-lg mb-2">4. Activación</h3>
                            <p class="text-sm text-slate-400">Se disparan campañas de marketing automatizadas y personalizadas.</p>
                        </div>
                        <div class="flip-card-back text-center">
                           <h3 class="font-bold text-lg mb-2 text-orange-400">Marketing de Precisión</h3>
                           <p class="text-sm text-slate-300">La automatización permite impactar al cliente correcto en el momento oportuno con ofertas relevantes que impulsan la conversión.</p>
                        </div>
                    </div>
                </div>
                <div class="flip-card hover-flip-card">
                    <div class="flip-card-inner">
                        <div class="flip-card-front card text-center">
                            <i data-lucide="bar-chart-2" class="w-12 h-12 mb-4 text-orange-500 mx-auto"></i>
                            <h3 class="font-bold text-lg mb-2">5. Medición</h3>
                            <p class="text-sm text-slate-400">Se mide el ROI, LTV y el impacto real de cada interacción en las ventas.</p>
                        </div>
                        <div class="flip-card-back text-center">
                            <h3 class="font-bold text-lg mb-2 text-orange-400">Cierre del Ciclo</h3>
                            <p class="text-sm text-slate-300">La solución permite atribuir ventas a las campañas de WiFi Marketing, demostrando el valor tangible y el ROI. Dejamos de adivinar y empezamos a medir.</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- SIMULATOR SECTION -->
        <section id="simulator" class="mb-24">
             <div class="flex flex-col md:flex-row justify-between items-center mb-8">
                <div class="text-center md:text-left mb-6 md:mb-0">
                    <h2 class="section-title !text-left !mb-0">Simulador Financiero Interactivo</h2>
                    <p class="section-subtitle !text-left !ml-0 max-w-2xl">Ajuste las variables y proyecte el impacto financiero real. Compare dos escenarios clave para el mercado venezolano.</p>
                </div>
                <button id="generate-report-btn" class="btn btn-primary"><i data-lucide="download" class="w-5 h-5 mr-2"></i>Generar Informe PDF</button>
            </div>
            
            <div class="text-center mb-8">
                <button id="btn-completa" class="btn btn-active mr-4">Escenario 1: Solución Completa (AGT)</button>
                <button id="btn-byod" class="btn btn-secondary">Escenario 2: Infraestructura Propia (BYOD)</button>
            </div>

            <!-- Panel de Control Horizontal -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
                <!-- Panel 1: Infraestructura -->
                <div class="card bg-slate-800/50">
                    <h3 class="text-xl font-bold mb-4 text-orange-400 flex items-center">
                        <span class="bg-orange-500 text-white rounded-full h-8 w-8 flex items-center justify-center mr-3 text-sm font-bold">1</span>
                        Infraestructura
                    </h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block mb-2 text-sm font-medium">APs Interiores</label>
                            <input type="number" id="aps-indoor" value="3" min="0" class="w-full p-2 rounded bg-slate-700 border border-slate-600 focus:ring-orange-500 focus:border-orange-500">
                        </div>
                        <div>
                            <label class="block mb-2 text-sm font-medium">APs Exteriores</label>
                            <input type="number" id="aps-outdoor" value="1" min="0" class="w-full p-2 rounded bg-slate-700 border border-slate-600 focus:ring-orange-500 focus:border-orange-500">
                        </div>
                    </div>
                </div>

                <!-- Panel 2: Métricas de Negocio -->
                <div class="card bg-slate-800/50">
                    <h3 class="text-xl font-bold mb-4 text-orange-400 flex items-center">
                       <span class="bg-orange-500 text-white rounded-full h-8 w-8 flex items-center justify-center mr-3 text-sm font-bold">2</span>
                       Métricas de Negocio
                    </h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block mb-2 text-sm font-medium">Valor de Vida del Cliente (LTV)</label>
                            <input type="number" id="customer-ltv" value="50" min="0" class="w-full p-2 rounded bg-slate-700 border border-slate-600 focus:ring-orange-500 focus:border-orange-500">
                        </div>
                    </div>
                </div>
                
                <!-- Panel 3: Costos y Financiamiento -->
                <div class="card bg-slate-800/50">
                     <h3 class="text-xl font-bold mb-4 text-orange-400 flex items-center">
                       <span class="bg-orange-500 text-white rounded-full h-8 w-8 flex items-center justify-center mr-3 text-sm font-bold">3</span>
                       Costos y Financiamiento
                    </h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block mb-2 text-sm font-medium">Costo Mensual de Internet</label>
                            <input type="number" id="internet-cost" value="100" min="0" class="w-full p-2 rounded bg-slate-700 border border-slate-600 focus:ring-orange-500 focus:border-orange-500">
                        </div>
                        <div id="financing-section">
                            <label for="financing-term" class="block mb-2 text-sm font-medium">Plazo de Financiamiento: <span id="financing-term-value" class="font-bold text-orange-400">0</span> meses</label>
                            <input type="range" id="financing-term" min="0" max="3" value="0" step="1" class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer">
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="scenario-image-container" class="my-8">
                 <img id="scenario-image" src="https://i.imgur.com/taauS8h.png" 
                     alt="Técnico instalando un punto de acceso Wi-Fi"
                     class="w-full h-auto max-h-96 object-cover rounded-lg transition-opacity duration-500">
            </div>


            <!-- Dashboard Unificado a Ancho Completo -->
            <div id="dashboard" class="grid grid-cols-1 md:grid-cols-3 gap-6">
                
                <!-- KPI Cards - Row 1 -->
                <div class="flip-card kpi-flip-card hover-flip-card">
                    <div class="flip-card-inner">
                        <div class="flip-card-front text-center">
                            <h3 class="text-lg font-semibold text-slate-400">Retorno de la Inversión (ROI)</h3>
                            <p id="roi-value" class="text-5xl font-extrabold text-green-400 my-2">0%</p>
                        </div>
                        <div class="flip-card-back">
                            <h3 class="font-bold text-lg mb-2 text-orange-400">Análisis del ROI</h3>
                            <p id="roi-text" class="text-sm text-slate-300">Este es el indicador final de rentabilidad. Muestra el porcentaje de ganancia neta sobre el costo total de la inversión a 36 meses.</p>
                        </div>
                    </div>
                </div>
                <div class="flip-card kpi-flip-card hover-flip-card">
                    <div class="flip-card-inner">
                        <div class="flip-card-front text-center">
                            <h3 class="text-lg font-semibold text-slate-400">Costo Total (TCO)</h3>
                            <p id="tco-value" class="text-4xl font-bold text-red-400 my-2">$0</p>
                        </div>
                         <div class="flip-card-back">
                            <h3 class="font-bold text-lg mb-2 text-orange-400">Análisis del TCO</h3>
                            <p id="tco-text" class="text-sm text-slate-300">Suma todos los costos proyectados a 36 meses: inversión inicial (CAPEX), costos operativos (OPEX) y el costo del financiamiento si aplica.</p>
                        </div>
                    </div>
                </div>
                <div class="flip-card kpi-flip-card hover-flip-card">
                    <div class="flip-card-inner">
                        <div class="flip-card-front text-center">
                             <h3 class="text-lg font-semibold text-slate-400">Período de Recuperación</h3>
                             <p id="payback-value" class="text-4xl font-bold text-blue-400 my-2">0 Meses</p>
                        </div>
                        <div class="flip-card-back">
                             <h3 class="font-bold text-lg mb-2 text-orange-400">Análisis del Payback</h3>
                             <p id="payback-text" class="text-sm text-slate-300">Indica el mes exacto en que los ingresos acumulados cubren la totalidad de los costos acumulados. A partir de este punto, la inversión genera ganancias netas.</p>
                        </div>
                    </div>
                </div>

                <!-- KPI Cards - Row 2 -->
                <div class="flip-card kpi-flip-card hover-flip-card">
                    <div class="flip-card-inner">
                        <div class="flip-card-front text-center">
                            <h3 class="text-lg font-semibold text-slate-400">Inversión Inicial (CAPEX)</h3>
                            <p id="capex-value" class="text-4xl font-bold text-slate-300 my-2">$0</p>
                        </div>
                        <div class="flip-card-back">
                            <h3 class="font-bold text-lg mb-2 text-orange-400">Análisis del CAPEX</h3>
                            <p id="capex-text" class="text-sm text-slate-300">Representa el desembolso único para adquirir e implementar la solución. Incluye hardware, componentes y servicios de configuración.</p>
                        </div>
                    </div>
                </div>
                <div class="flip-card kpi-flip-card hover-flip-card">
                    <div class="flip-card-inner">
                        <div class="flip-card-front text-center">
                            <h3 class="text-lg font-semibold text-slate-400">Costos Operativos (OPEX)</h3>
                            <p id="opex-value" class="text-4xl font-bold text-slate-300 my-2">$0</p>
                        </div>
                         <div class="flip-card-back">
                            <h3 class="font-bold text-lg mb-2 text-orange-400">Análisis del OPEX</h3>
                            <p id="opex-text" class="text-sm text-slate-300">Suma todos los costos recurrentes necesarios para mantener la solución funcionando durante 36 meses, como licencias y el servicio de internet.</p>
                        </div>
                    </div>
                </div>
                <div class="flip-card kpi-flip-card hover-flip-card">
                    <div class="flip-card-inner">
                        <div class="flip-card-front text-center">
                             <h3 class="text-lg font-semibold text-slate-400">Beneficio Neto</h3>
                             <p id="net-benefit-value" class="text-4xl font-bold text-green-400 my-2">$0</p>
                        </div>
                        <div class="flip-card-back">
                             <h3 class="font-bold text-lg mb-2 text-orange-400">Análisis del Beneficio</h3>
                             <p id="net-benefit-text" class="text-sm text-slate-300">Es el resultado final después de 36 meses: Ingresos Totales Generados menos el Costo Total de Propiedad (TCO). Es la ganancia real del proyecto.</p>
                        </div>
                    </div>
                </div>


                <!-- Chart Grid -->
                <div class="flip-card chart-flip-card md:col-span-1">
                    <div class="flip-card-inner">
                        <div class="flip-card-front text-center">
                             <i data-lucide="info" class="flip-trigger"></i>
                            <h3 class="font-bold mb-2">Desglose TCO (CAPEX vs OPEX)</h3>
                            <canvas id="tcoBreakdownChart"></canvas>
                        </div>
                        <div class="flip-card-back">
                             <h3 class="font-bold text-lg mb-2 text-orange-400">Análisis del Gráfico</h3>
                             <p id="tcoBreakdown-text" class="text-sm text-slate-300"></p>
                            <button class="btn btn-secondary flip-back-trigger mt-4"><i data-lucide="arrow-left" class="w-4 h-4 mr-2"></i>Volver</button>
                        </div>
                    </div>
                </div>

                 <div class="flip-card chart-flip-card md:col-span-2">
                    <div class="flip-card-inner">
                        <div class="flip-card-front text-center">
                             <i data-lucide="info" class="flip-trigger"></i>
                            <h3 class="font-bold mb-2">Desglose TCO (por Componente)</h3>
                            <canvas id="tcoComponentBreakdownChart"></canvas>
                        </div>
                        <div class="flip-card-back">
                            <h3 class="font-bold text-lg mb-2 text-orange-400">Análisis del Gráfico</h3>
                            <p id="tcoComponent-text" class="text-sm text-slate-300"></p>
                            <button class="btn btn-secondary flip-back-trigger mt-4"><i data-lucide="arrow-left" class="w-4 h-4 mr-2"></i>Volver</button>
                        </div>
                    </div>
                </div>

                 <div class="flip-card chart-flip-card md:col-span-2">
                    <div class="flip-card-inner">
                        <div class="flip-card-front text-center">
                             <i data-lucide="info" class="flip-trigger"></i>
                            <h3 class="font-bold mb-2">Evolución de Costos Mensuales</h3>
                            <canvas id="monthlyCostsChart"></canvas>
                        </div>
                        <div class="flip-card-back">
                             <h3 class="font-bold text-lg mb-2 text-orange-400">Análisis del Gráfico</h3>
                             <p id="monthlyCosts-text" class="text-sm text-slate-300"></p>
                            <button class="btn btn-secondary flip-back-trigger mt-4"><i data-lucide="arrow-left" class="w-4 h-4 mr-2"></i>Volver</button>
                        </div>
                    </div>
                </div>

                <div class="flip-card chart-flip-card md:col-span-1">
                    <div class="flip-card-inner">
                        <div class="flip-card-front text-center">
                             <i data-lucide="info" class="flip-trigger"></i>
                            <h3 class="font-bold mb-2">Flujo de Caja Acumulado</h3>
                            <canvas id="cumulativeCashflowChart"></canvas>
                        </div>
                        <div class="flip-card-back">
                             <h3 class="font-bold text-lg mb-2 text-orange-400">Análisis del Gráfico</h3>
                             <p id="cumulativeCashflow-text" class="text-sm text-slate-300"></p>
                            <button class="btn btn-secondary flip-back-trigger mt-4"><i data-lucide="arrow-left" class="w-4 h-4 mr-2"></i>Volver</button>
                        </div>
                    </div>
                </div>
                
                <div class="flip-card chart-flip-card md:col-span-3">
                    <div class="flip-card-inner">
                        <div class="flip-card-front text-center">
                             <i data-lucide="info" class="flip-trigger"></i>
                            <h3 class="font-bold mb-2">Simulación Monte Carlo del ROI</h3>
                            <canvas id="monteCarloChart"></canvas>
                        </div>
                        <div class="flip-card-back">
                             <h3 class="font-bold text-lg mb-2 text-orange-400">Análisis del Gráfico</h3>
                             <p id="monteCarlo-text" class="text-sm text-slate-300"></p>
                            <button class="btn btn-secondary flip-back-trigger mt-4"><i data-lucide="arrow-left" class="w-4 h-4 mr-2"></i>Volver</button>
                        </div>
                    </div>
                </div>

                <div class="flip-card chart-flip-card md:col-span-2">
                    <div class="flip-card-inner">
                        <div class="flip-card-front text-center">
                             <i data-lucide="info" class="flip-trigger"></i>
                            <h3 class="font-bold mb-2">Ingresos vs Costos (Crossover)</h3>
                            <canvas id="crossoverChart"></canvas>
                        </div>
                        <div class="flip-card-back">
                             <h3 class="font-bold text-lg mb-2 text-orange-400">Análisis del Gráfico</h3>
                             <p id="crossover-text" class="text-sm text-slate-300"></p>
                            <button class="btn btn-secondary flip-back-trigger mt-4"><i data-lucide="arrow-left" class="w-4 h-4 mr-2"></i>Volver</button>
                        </div>
                    </div>
                </div>
                
                <div class="flip-card chart-flip-card md:col-span-1">
                    <div class="flip-card-inner">
                        <div class="flip-card-front text-center">
                             <i data-lucide="info" class="flip-trigger"></i>
                            <h3 class="font-bold mb-2">Componentes del ROI</h3>
                            <canvas id="roiComponentsChart"></canvas>
                        </div>
                        <div class="flip-card-back">
                             <h3 class="font-bold text-lg mb-2 text-orange-400">Análisis del Gráfico</h3>
                             <p id="roiComponents-text" class="text-sm text-slate-300"></p>
                            <button class="btn btn-secondary flip-back-trigger mt-4"><i data-lucide="arrow-left" class="w-4 h-4 mr-2"></i>Volver</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- SIGNIFICADOS SECTION -->
        <section id="glossary" class="mb-16">
            <h2 class="section-title">Glosario Financiero</h2>
            <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                 <div class="flip-card hover-flip-card">
                    <div class="flip-card-inner">
                        <div class="flip-card-front card text-center">
                            <h3 class="font-bold text-lg text-orange-400 mb-2">Retorno de la Inversión (ROI)</h3>
                            <p class="text-sm text-slate-300">Mide la ganancia o pérdida generada en relación con el monto invertido.</p>
                        </div>
                        <div class="flip-card-back text-center">
                           <p class="text-sm text-slate-300">Un ROI alto indica alta rentabilidad. Es el indicador final del éxito financiero de una inversión.</p>
                        </div>
                    </div>
                </div>
                 <div class="flip-card hover-flip-card">
                    <div class="flip-card-inner">
                        <div class="flip-card-front card text-center">
                            <h3 class="font-bold text-lg text-orange-400 mb-2">Costo Total de Propiedad (TCO)</h3>
                            <p class="text-sm text-slate-300">Cálculo de todos los costos de la solución en su vida útil (3 años).</p>
                        </div>
                        <div class="flip-card-back text-center">
                            <p class="text-sm text-slate-300">Incluye costos directos (hardware, licencias) e indirectos (soporte, mantenimiento), ofreciendo una visión completa de la inversión.</p>
                        </div>
                    </div>
                </div>
                <div class="flip-card hover-flip-card">
                    <div class="flip-card-inner">
                        <div class="flip-card-front card text-center">
                            <h3 class="font-bold text-lg text-orange-400 mb-2">Período de Recuperación</h3>
                            <p class="text-sm text-slate-300">El tiempo necesario para que los ingresos generados igualen la inversión.</p>
                        </div>
                        <div class="flip-card-back text-center">
                           <p class="text-sm text-slate-300">Un período de recuperación (Payback) corto es ideal, ya que indica que la inversión comienza a generar ganancias netas rápidamente.</p>
                        </div>
                    </div>
                </div>
                <div class="flip-card hover-flip-card">
                    <div class="flip-card-inner">
                        <div class="flip-card-front card text-center">
                           <h3 class="font-bold text-lg text-orange-400 mb-2">Valor de Vida del Cliente (LTV)</h3>
                           <p class="text-sm text-slate-300">La ganancia neta total que se espera de un cliente durante toda su relación comercial.</p>
                        </div>
                        <div class="flip-card-back text-center">
                           <p class="text-sm text-slate-300">Aumentar el LTV es un objetivo clave. Esta solución lo potencia a través del marketing de fidelización y la re-compra.</p>
                        </div>
                    </div>
                </div>
                 <div class="flip-card hover-flip-card">
                    <div class="flip-card-inner">
                        <div class="flip-card-front card text-center">
                           <h3 class="font-bold text-lg text-orange-400 mb-2">CAPEX</h3>
                           <p class="text-sm text-slate-300">Gastos en activos fijos (Capital Expenditures), como el hardware. Es una inversión inicial.</p>
                        </div>
                         <div class="flip-card-back text-center">
                           <p class="text-sm text-slate-300">Se realiza una sola vez y se deprecia con el tiempo. Distinto de los gastos operativos recurrentes.</p>
                        </div>
                    </div>
                </div>
                <div class="flip-card hover-flip-card">
                    <div class="flip-card-inner">
                        <div class="flip-card-front card text-center">
                            <h3 class="font-bold text-lg text-orange-400 mb-2">OPEX</h3>
                            <p class="text-sm text-slate-300">Gastos operativos continuos (Operational Expenditures), como licencias y soporte.</p>
                        </div>
                        <div class="flip-card-back text-center">
                            <p class="text-sm text-slate-300">Son los costos recurrentes para mantener la solución funcionando. Son predecibles y se presupuestan anualmente.</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        
        <footer class="text-center py-8 border-t border-slate-700">
            <p class="text-slate-400">Simulador Financiero v16.9 | Desarrollado por Gemini para AGT Comunidades</p>
        </footer>

    </div>

    <!-- PDF Report Modal -->
    <div id="report-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 transition-opacity duration-300 opacity-0 pointer-events-none">
        <div class="bg-slate-800 rounded-lg shadow-xl p-8 max-w-3xl w-full max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-orange-400">Resumen Ejecutivo de la Simulación</h2>
                <button id="report-close-btn" class="text-slate-400 hover:text-white">&times;</button>
            </div>
            <div id="report-content-container" class="bg-slate-900 p-6 rounded-md mb-6">
                <!-- Content will be injected here -->
            </div>
            <div class="text-right">
                <button id="report-download-btn" class="btn btn-primary"><i data-lucide="download" class="w-5 h-5 mr-2"></i>Descargar PDF</button>
            </div>
        </div>
    </div>

<script>
    // V16.9 CALCULATION ENGINE - Final Polish, PDF Consultant Analysis
    const PRICING = {
        CONTROLLER_COST: 179.00, AP_INDOOR_COST: 95.00, AP_OUTDOOR_COST: 144.00, HARDWARE_MARKUP: 0.25,
        AUX_COMPONENTS_FIXED: 850.00, INSTALL_FEE_PER_AP: 75.00, CONFIG_FEE_FIXED: 200.00, BYOD_CONFIG_FEE_FIXED: 1000.00,
        LICENSE_OHMYFI_PER_AP_MONTHLY: 16.00, LICENSE_ZOHO_FIXED_MONTHLY: 50.00,
        FINANCING_RATES: { "0": 0, "1": 0.25, "2": 0.30, "3": 0.35 }
    };

    const ROI_PARAMS = {
        CONVERSION_RATE: 0.10, // v6 Logic
        LEADS_PER_AP: 25      // v6 Logic
    };
    
    const IMAGE_URLS = {
        header: 'https://i.imgur.com/YjSq4q3.png',
        completa: 'https://i.imgur.com/taauS8h.png',
        byod: 'https://i.imgur.com/z1hQQnN.png'
    };

    const ui = {
        headerImage: document.querySelector('header img'),
        scenarioImage: document.getElementById('scenario-image'),
        buttons: { completa: document.getElementById('btn-completa'), byod: document.getElementById('btn-byod') },
        inputs: { 
            apsIndoor: document.getElementById('aps-indoor'), 
            apsOutdoor: document.getElementById('aps-outdoor'), 
            customerLTV: document.getElementById('customer-ltv'), 
            internetCost: document.getElementById('internet-cost'),
        },
        financing: { section: document.getElementById('financing-section'), slider: document.getElementById('financing-term'), valueLabel: document.getElementById('financing-term-value') },
        outputs: { 
            roi: { value: document.getElementById('roi-value'), text: document.getElementById('roi-text') }, 
            tco: { value: document.getElementById('tco-value'), text: document.getElementById('tco-text') }, 
            payback: { value: document.getElementById('payback-value'), text: document.getElementById('payback-text') },
            capex: { value: document.getElementById('capex-value'), text: document.getElementById('capex-text') },
            opex: { value: document.getElementById('opex-value'), text: document.getElementById('opex-text') },
            netBenefit: { value: document.getElementById('net-benefit-value'), text: document.getElementById('net-benefit-text') },
            analysis: {
                tcoBreakdown: document.getElementById('tcoBreakdown-text'),
                tcoComponent: document.getElementById('tcoComponent-text'),
                monthlyCosts: document.getElementById('monthlyCosts-text'),
                cumulativeCashflow: document.getElementById('cumulativeCashflow-text'),
                monteCarlo: document.getElementById('monteCarlo-text'),
                crossover: document.getElementById('crossover-text'),
                roiComponents: document.getElementById('roiComponents-text')
            }
        },
        report: { modal: document.getElementById('report-modal'), contentContainer: document.getElementById('report-content-container'), generateBtn: document.getElementById('generate-report-btn'), closeBtn: document.getElementById('report-close-btn'), downloadBtn: document.getElementById('report-download-btn') }
    };

    let currentScenario = 'completa';
    let charts = {};
    let lastCalculationData = {};

    function initialize() {
        ui.headerImage.src = IMAGE_URLS.header;
        setupEventListeners();
        createCharts();
        setScenario('completa');
    }

    function setupEventListeners() {
        ui.buttons.completa.addEventListener('click', () => setScenario('completa'));
        ui.buttons.byod.addEventListener('click', () => setScenario('byod'));
        Object.values(ui.inputs).forEach(input => input.addEventListener('input', calculate));
        ui.financing.slider.addEventListener('input', () => { ui.financing.valueLabel.textContent = ui.financing.slider.value; calculate(); });

        // Corrected Event Listeners for Chart Flips
        document.querySelectorAll('.flip-trigger').forEach(trigger => {
            trigger.addEventListener('click', (e) => {
                e.stopPropagation();
                trigger.closest('.chart-flip-card').classList.add('is-flipped');
            });
        });

        document.querySelectorAll('.flip-back-trigger').forEach(trigger => {
            trigger.addEventListener('click', (e) => {
                e.stopPropagation();
                trigger.closest('.chart-flip-card').classList.remove('is-flipped');
            });
        });
        
        ui.report.generateBtn.addEventListener('click', () => { 
            ui.report.contentContainer.innerHTML = generateReportHTML(lastCalculationData);
            ui.report.modal.classList.remove('opacity-0', 'pointer-events-none'); 
        });
        ui.report.closeBtn.addEventListener('click', () => ui.report.modal.classList.add('opacity-0', 'pointer-events-none'));
        ui.report.downloadBtn.addEventListener('click', () => downloadPDF(lastCalculationData));
        lucide.createIcons();
    }

    function setScenario(scenario) {
        currentScenario = scenario;
        ui.buttons.completa.classList.toggle('btn-active', scenario === 'completa');
        ui.buttons.completa.classList.toggle('btn-secondary', scenario !== 'completa');
        ui.buttons.byod.classList.toggle('btn-active', scenario === 'byod');
        ui.buttons.byod.classList.toggle('btn-secondary', scenario !== 'byod');
        ui.financing.section.style.display = scenario === 'completa' ? 'block' : 'none';
        
        ui.scenarioImage.style.opacity = 0;
        setTimeout(() => {
            ui.scenarioImage.src = scenario === 'completa' ? IMAGE_URLS.completa : IMAGE_URLS.byod;
            ui.scenarioImage.style.opacity = 1;
        }, 300);

        calculate();
    }

    function calculate() {
        try {
            const values = {
                apsIndoor: parseInt(ui.inputs.apsIndoor.value) || 0,
                apsOutdoor: parseInt(ui.inputs.apsOutdoor.value) || 0,
                customerLTV: parseFloat(ui.inputs.customerLTV.value) || 0,
                internetCost: parseFloat(ui.inputs.internetCost.value) || 0,
                financingTerm: parseInt(ui.financing.slider.value, 10) || 0
            };

            const totalAps = values.apsIndoor + values.apsOutdoor;

            let hardwarePrice = 0, servicesPrice = 0, capex = 0;
            if (currentScenario === 'completa') {
                const hardwareBaseCost = PRICING.CONTROLLER_COST + (values.apsIndoor * PRICING.AP_INDOOR_COST) + (values.apsOutdoor * PRICING.AP_OUTDOOR_COST);
                hardwarePrice = hardwareBaseCost * (1 + PRICING.HARDWARE_MARKUP);
                servicesPrice = PRICING.AUX_COMPONENTS_FIXED + PRICING.CONFIG_FEE_FIXED + (totalAps * PRICING.INSTALL_FEE_PER_AP);
                capex = hardwarePrice + servicesPrice;
            } else { // byod
                capex = PRICING.BYOD_CONFIG_FEE_FIXED;
                servicesPrice = capex;
            }

            const monthlyLicenseCost = (totalAps * PRICING.LICENSE_OHMYFI_PER_AP_MONTHLY) + PRICING.LICENSE_ZOHO_FIXED_MONTHLY;
            const monthlyOpex = monthlyLicenseCost + values.internetCost;
            const totalOpex = monthlyOpex * 36;
            
            let financingCost = 0;
            let monthlyFinancingPayment = 0;
            if (currentScenario === 'completa' && values.financingTerm > 0) {
                const rate = PRICING.FINANCING_RATES[values.financingTerm];
                financingCost = capex * rate;
                monthlyFinancingPayment = (capex + financingCost) / values.financingTerm;
            }
            
            const tco = capex + totalOpex + financingCost;
            const newCustomersMonthly = totalAps * ROI_PARAMS.LEADS_PER_AP * ROI_PARAMS.CONVERSION_RATE;
            const monthlyRevenue = newCustomersMonthly * values.customerLTV;
            const totalRevenue = monthlyRevenue * 36;
            const netBenefit = totalRevenue - tco;
            const roi = tco > 0 ? (netBenefit / tco) : 0;
            
            const effectiveInitialOutlay = (currentScenario === 'completa' && values.financingTerm > 0) ? 0 : capex;
            let cumulativeNet = -effectiveInitialOutlay;
            let paybackPeriod = -1;
            const monthlyData = { costs: [], revenues: [], opexOnly: [], financing: [], capex: [], cumulativeNet: [] };

            for (let month = 1; month <= 36; month++) {
                const financingPaymentThisMonth = (month <= values.financingTerm) ? monthlyFinancingPayment : 0;
                const currentMonthCost = monthlyOpex + financingPaymentThisMonth;
                cumulativeNet += monthlyRevenue - currentMonthCost;
                
                if (cumulativeNet >= 0 && paybackPeriod === -1) {
                    paybackPeriod = month;
                }

                const cumulativeCostForChart = effectiveInitialOutlay + (monthlyOpex * month) + (Math.min(month, values.financingTerm) * monthlyFinancingPayment);
                monthlyData.revenues.push(monthlyRevenue * month);
                monthlyData.costs.push(cumulativeCostForChart);
                monthlyData.opexOnly.push(monthlyOpex);
                monthlyData.financing.push(financingPaymentThisMonth);
                monthlyData.capex.push(month === 1 ? effectiveInitialOutlay : 0);
                monthlyData.cumulativeNet.push(cumulativeNet);
            }

            const tcoComponents = { hardware: hardwarePrice, services: servicesPrice, licenses: totalOpex };
            const monteCarloResults = runMonteCarlo(values, totalAps, capex, monthlyOpex, financingCost);
            lastCalculationData = { ...values, totalAps, capex, tco, totalRevenue, netBenefit, roi, paybackPeriod, totalOpex, financingCost, monthlyFinancingPayment, scenario: currentScenario, monteCarloResults, monthlyData, tcoComponents };
            
            updateUI(lastCalculationData);
        } catch (error) {
            console.error("Calculation failed:", error);
        }
    }
    
    function runMonteCarlo(values, totalAps, capex, monthlyOpex, financingCost) {
        const simulations = 10000;
        const results = [];
        const totalOpexSim = monthlyOpex * 36;
        for (let i = 0; i < simulations; i++) {
            const ltvVar = values.customerLTV * (0.8 + Math.random() * 0.4); // +/- 20%
            const convRateVar = ROI_PARAMS.CONVERSION_RATE * (0.8 + Math.random() * 0.4); // +/- 20%
            const leadsPerApVar = ROI_PARAMS.LEADS_PER_AP * (0.8 + Math.random() * 0.4);
            const newCustMonthVar = totalAps * leadsPerApVar * convRateVar;
            const totalRevVar = newCustMonthVar * 36 * ltvVar;
            const tcoVar = capex + totalOpexSim + financingCost;
            const netBenefitVar = totalRevVar - tcoVar;
            const roiVar = tcoVar > 0 ? (netBenefitVar / tcoVar) : 0;
            results.push(roiVar);
        }
        return results;
    }

    const formatCurrency = (val) => `$${val.toLocaleString('en-US', {maximumFractionDigits:0})}`;

    function updateUI(d) {
        // Update main KPIs
        ui.outputs.roi.value.textContent = `${(d.roi * 100).toFixed(0)}%`;
        ui.outputs.tco.value.textContent = formatCurrency(d.tco);
        ui.outputs.payback.value.textContent = d.paybackPeriod > 0 ? `${d.paybackPeriod} Meses` : "N/A";
        ui.outputs.capex.value.textContent = formatCurrency(d.capex);
        ui.outputs.opex.value.textContent = formatCurrency(d.totalOpex);
        ui.outputs.netBenefit.value.textContent = formatCurrency(d.netBenefit);

        // Update KPI explanation texts
        if(d.financingTerm > 0 && d.paybackPeriod > 0){
            ui.outputs.payback.text.innerHTML = `Al optar por el financiamiento a <strong>${d.financingTerm} meses</strong>, el desembolso inicial es $0. Esto protege su liquidez y permite que el punto de equilibrio se alcance en solo <strong>${d.paybackPeriod} meses</strong>.`;
        } else if (d.paybackPeriod > 0) {
            ui.outputs.payback.text.textContent = `La inversión inicial se recupera y la solución empieza a generar ganancias netas en el mes ${d.paybackPeriod}.`;
        } else {
            ui.outputs.payback.text.textContent = 'Bajo este escenario, los ingresos generados no logran cubrir los costos totales en el período de 36 meses.';
        }
        
        updateAnalysisTexts(d);
        updateCharts(d);
    }

    function updateAnalysisTexts(d) {
        // ... (Analysis text generation remains the same)
        ui.outputs.analysis.tcoBreakdown.innerHTML = `
            <strong class="text-slate-100 block mb-2">Racional Funcional:</strong>
            Esto te ayuda a entender dónde se va tu dinero. Compara tu inversión inicial (lo que pagas una vez) con tus costos fijos para mantener todo funcionando (lo que pagas recurrentemente).
            <br><br>
            <strong class="text-slate-100 block mb-2">Memoria de Cálculo:</strong>
            TCO = (Inversión: ${formatCurrency(d.capex)} + Costo Financ.: ${formatCurrency(d.financingCost)}) + (Costos Operativos: ${formatCurrency(d.totalOpex)})`;
        ui.outputs.analysis.tcoComponent.innerHTML = `
            <strong class="text-slate-100 block mb-2">Racional Funcional:</strong>
            Aquí detallamos tu inversión. Te muestra cuánto corresponde a los equipos físicos (Hardware), cuánto a la instalación y configuración (Servicios), y cuánto a los permisos de uso y soporte (Licencias).
            <br><br>
            <strong class="text-slate-100 block mb-2">Memoria de Cálculo:</strong>
            TCO = Hardware (${formatCurrency(d.tcoComponents.hardware)}) + Servicios (${formatCurrency(d.tcoComponents.services)}) + Licencias (${formatCurrency(d.tcoComponents.licenses)})`;
        ui.outputs.analysis.monthlyCosts.innerHTML = `
            <strong class="text-slate-100 block mb-2">Racional Funcional:</strong>
            Este es tu flujo de gastos mes a mes. Te permite ver el impacto de la inversión inicial y cómo se distribuyen tus pagos fijos (operativos y de financiamiento) a lo largo del primer año.
            <br><br>
            <strong class="text-slate-100 block mb-2">Memoria de Cálculo:</strong>
            Costo Mensual = OPEX (${formatCurrency(d.monthlyData.opexOnly[0])}) + Cuota Financ. (${formatCurrency(d.monthlyData.financing[0])})`;
        ui.outputs.analysis.cumulativeCashflow.innerHTML = `
            <strong class="text-slate-100 block mb-2">Racional Funcional:</strong>
            Este es el gráfico más importante para tu rentabilidad. Muestra cómo, mes a mes, los ingresos van pagando la inversión hasta que la línea cruza el 'cero'. Ese es tu punto de equilibrio, cuando empiezas a ganar dinero.
            <br><br>
            <strong class="text-slate-100 block mb-2">Memoria de Cálculo:</strong>
            Punto de Equilibrio = Mes en que (Ingresos Acumulados - Costos Acumulados) >= 0. <br><strong>Resultado: Mes ${d.paybackPeriod > 0 ? d.paybackPeriod : 'N/A'}</strong>`;
        const positiveProbability = (d.monteCarloResults.filter(r => r > 0).length / d.monteCarloResults.length * 100).toFixed(0);
        ui.outputs.analysis.monteCarlo.innerHTML = `
            <strong class="text-slate-100 block mb-2">Racional Funcional:</strong>
            El futuro es incierto, y este análisis te prepara. Simulamos 10,000 escenarios económicos (buenos y malos) para ver qué tan probable es que tu inversión sea rentable. La barra naranja muestra el resultado más probable.
            <br><br>
            <strong class="text-slate-100 block mb-2">Memoria de Cálculo:</strong>
            Probabilidad de un ROI positivo (mayor a 0%) en 10,000 simulaciones: <strong>${positiveProbability}%</strong>`;
        const revenueAtPayback = d.paybackPeriod > 0 ? d.monthlyData.revenues[d.paybackPeriod - 1] : 0;
        const costAtPayback = d.paybackPeriod > 0 ? d.monthlyData.costs[d.paybackPeriod - 1] : 0;
        ui.outputs.analysis.crossover.innerHTML = `
            <strong class="text-slate-100 block mb-2">Racional Funcional:</strong>
            Visualiza la carrera entre tus ingresos y tus costos. La línea verde (ingresos) debe superar a la naranja (costos). El punto donde se cruzan es tu 'Punto de Equilibrio'.
            <br><br>
            <strong class="text-slate-100 block mb-2">Memoria de Cálculo:</strong>
            Crossover = Mes ${d.paybackPeriod > 0 ? d.paybackPeriod : 'N/A'}, cuando Ingresos (${formatCurrency(revenueAtPayback)}) superan Costos (${formatCurrency(costAtPayback)})`;
        ui.outputs.analysis.roiComponents.innerHTML = `
            <strong class="text-slate-100 block mb-2">Racional Funcional:</strong>
            En simple: ¿cuánto ganas por cada dólar que inviertes? Comparamos la barra de todo lo que gastas (Costo Total) con la de todo lo que ganas (Ingreso Total). La diferencia es tu ganancia neta.
            <br><br>
            <strong class="text-slate-100 block mb-2">Memoria de Cálculo:</strong>
            Beneficio Neto = Ingresos Totales (${formatCurrency(d.totalRevenue)}) - TCO (${formatCurrency(d.tco)}) = <strong>${formatCurrency(d.netBenefit)}</strong>`;
    }

    function createCharts() {
        // ... (Chart creation remains the same)
        const chartOptions = { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { color: 'white' } } }, scales: { x: { ticks: { color: 'white' }, grid: { color: '#334155' } }, y: { ticks: { color: 'white' }, grid: { color: '#334155' } } } };
        try { charts.tcoBreakdown = new Chart(document.getElementById('tcoBreakdownChart').getContext('2d'), { type: 'doughnut', data: { labels: ['Inversión (CAPEX + Finan.)', 'Costos Operativos (OPEX)'], datasets: [{ data: [], backgroundColor: ['#3B82F6', '#F97316'] }] }, options: { ...chartOptions, scales: {} } }); } catch (e) { console.error("Failed to create tcoBreakdownChart:", e); }
        try { charts.tcoComponentBreakdown = new Chart(document.getElementById('tcoComponentBreakdownChart').getContext('2d'), { type: 'doughnut', data: { labels: ['Hardware', 'Servicios', 'Licencias y Soporte'], datasets: [{ data: [], backgroundColor: ['#3B82F6', '#10B981', '#F97316'] }] }, options: { ...chartOptions, scales: {} } }); } catch (e) { console.error("Failed to create tcoComponentBreakdownChart:", e); }
        try { charts.cumulativeCashflow = new Chart(document.getElementById('cumulativeCashflowChart').getContext('2d'), { type: 'line', data: { labels: Array.from({ length: 37 }, (_, i) => `M${i}`), datasets: [{ label: 'Flujo de Caja Acumulado', data: [], borderColor: '#22C55E', tension: 0.1, fill: true, backgroundColor: 'rgba(34, 197, 94, 0.2)' }] }, options: { ...chartOptions, scales: { ...chartOptions.scales, x: { ...chartOptions.scales.x, title: { display: true, text: 'Meses', color:'white' } } } } }); } catch (e) { console.error("Failed to create cumulativeCashflowChart:", e); }
        try { charts.monthlyCosts = new Chart(document.getElementById('monthlyCostsChart').getContext('2d'), { type: 'bar', data: { labels: Array.from({ length: 12 }, (_, i) => `Mes ${i+1}`), datasets: [ { label: 'CAPEX (Mes 1)', data: [], backgroundColor: '#3B82F6' }, { label: 'OPEX', data: [], backgroundColor: '#F97316' }, { label: 'Financiamiento', data: [], backgroundColor: '#8B5CF6' } ] }, options: { ...chartOptions, scales: { ...chartOptions.scales, x: { stacked: true }, y: { stacked: true } } } }); } catch (e) { console.error("Failed to create monthlyCostsChart:", e); }
        try { charts.monteCarlo = new Chart(document.getElementById('monteCarloChart').getContext('2d'), { type: 'bar', data: { labels: [], datasets: [{ label: 'Frecuencia', data: [], backgroundColor: '#8B5CF6' }] }, options: { ...chartOptions, scales: { ...chartOptions.scales, x: { ...chartOptions.scales.x, title: { display: true, text: 'Rango de ROI (%)', color:'white' } }, y: { ...chartOptions.scales.y, title: { display: true, text: 'Nº de Simulaciones', color:'white' } } } } }); } catch (e) { console.error("Failed to create monteCarloChart:", e); }
        try { charts.crossover = new Chart(document.getElementById('crossoverChart').getContext('2d'), { type: 'line', data: { labels: Array.from({ length: 36 }, (_, i) => i + 1), datasets: [{ label: 'Costos Acumulados', data: [], borderColor: '#F97316', fill: true, backgroundColor: 'rgba(249, 115, 22, 0.2)', tension: 0.1 }, { label: 'Ingresos Acumulados', data: [], borderColor: '#22C55E', fill: true, backgroundColor: 'rgba(34, 197, 94, 0.2)', tension: 0.1 }] }, options: { ...chartOptions, scales: { ...chartOptions.scales, x: { ...chartOptions.scales.x, title: { display: true, text: 'Meses', color:'white' } } } } }); } catch(e) { console.error("Failed to create crossoverChart:", e); }
        try { charts.roiComponents = new Chart(document.getElementById('roiComponentsChart').getContext('2d'), { type: 'bar', data: { labels: ['Costo Total (TCO)', 'Ingreso Total'], datasets: [{ data: [], backgroundColor: ['#DC2626', '#22C55E'], label: 'Monto en USD' }] }, options: { ...chartOptions, plugins: { legend: { display: false } } } }); } catch(e) { console.error("Failed to create roiComponentsChart:", e); }
    }

    function updateCharts(d) {
        try { if (charts.tcoBreakdown) { charts.tcoBreakdown.data.datasets[0].data = [d.capex + d.financingCost, d.totalOpex]; charts.tcoBreakdown.update(); } } catch (e) { console.error("Failed to update tcoBreakdownChart:", e); }
        try { if (charts.tcoComponentBreakdown) { charts.tcoComponentBreakdown.data.datasets[0].data = [d.tcoComponents.hardware, d.tcoComponents.services, d.tcoComponents.licenses]; charts.tcoComponentBreakdown.update(); } } catch (e) { console.error("Failed to update tcoComponentBreakdownChart:", e); }
        try { if (charts.cumulativeCashflow) { charts.cumulativeCashflow.data.datasets[0].data = [d.financingTerm > 0 ? 0 : -d.capex, ...d.monthlyData.cumulativeNet]; charts.cumulativeCashflow.update(); } } catch (e) { console.error("Failed to update cumulativeCashflowChart:", e); }
        try { if (charts.monthlyCosts) { charts.monthlyCosts.data.datasets[0].data = d.monthlyData.capex.slice(0, 12); charts.monthlyCosts.data.datasets[1].data = d.monthlyData.opexOnly.slice(0, 12); charts.monthlyCosts.data.datasets[2].data = d.monthlyData.financing.slice(0, 12); charts.monthlyCosts.update(); } } catch (e) { console.error("Failed to update monthlyCostsChart:", e); }
        try { if (charts.crossover) { charts.crossover.data.datasets[0].data = d.monthlyData.costs; charts.crossover.data.datasets[1].data = d.monthlyData.revenues; charts.crossover.update(); } } catch (e) { console.error("Failed to update crossoverChart:", e); }
        try { if (charts.roiComponents) { charts.roiComponents.data.datasets[0].data = [d.tco, d.totalRevenue]; charts.roiComponents.update(); } } catch (e) { console.error("Failed to update roiComponentsChart:", e); }
        try {
            if (charts.monteCarlo) {
                const bins = {};
                const binSize = 0.5; // 50%
                d.monteCarloResults.forEach(roi => {
                    const bin = Math.floor(roi / binSize) * binSize;
                    bins[bin] = (bins[bin] || 0) + 1;
                });
                const sortedBins = Object.keys(bins).map(parseFloat).sort((a, b) => a - b);
                const dataValues = sortedBins.map(bin => bins[bin]);
                const maxVal = Math.max(...dataValues);
                const backgroundColors = dataValues.map(val => val === maxVal ? '#F97316' : '#8B5CF6');
                charts.monteCarlo.data.labels = sortedBins.map(bin => `${(bin*100).toFixed(0)}% a ${((bin + binSize)*100).toFixed(0)}%`);
                charts.monteCarlo.data.datasets[0].data = dataValues;
                charts.monteCarlo.data.datasets[0].backgroundColor = backgroundColors;
                charts.monteCarlo.update();
            }
        } catch (e) { console.error("Failed to update monteCarloChart:", e); }
    }
    
    function generateConsultantAnalysis(d) {
        let analysis = `\n\nANÁLISIS Y RECOMENDACIÓN DEL CONSULTOR\n`;
        analysis += `=========================================\n\n`;
        analysis += `Actuando como sus consultores especializados en la sinergia entre Ohmyfi y Zoho CRM, hemos interpretado los resultados de la simulación para ofrecerle una recomendación estratégica clara y directa.\n\n`;

        if (d.roi > 0.5 && d.paybackPeriod <= 12) {
            analysis += `La simulación revela una oportunidad de inversión excepcionalmente sólida. Con un ROI proyectado del ${(d.roi * 100).toFixed(0)}% y un período de recuperación de tan solo ${d.paybackPeriod} meses, el proyecto no solo es financieramente viable, sino que promete una alta rentabilidad a corto plazo. El beneficio neto de ${formatCurrency(d.netBenefit)} a 36 meses subraya el potencial de la solución para convertirse en un centro de ganancias significativo.\n\n`;
            analysis += `RECOMENDACIÓN: Proceder con la implementación. El bajo riesgo y el rápido retorno sugieren que cualquier retraso podría significar una pérdida de oportunidad para capitalizar la monetización de su red Wi-Fi y la inteligencia de clientes que proporciona la integración con Zoho CRM.`;
        } else if (d.roi > 0) {
            analysis += `El análisis indica que el proyecto es rentable en el horizonte de 36 meses, con un ROI positivo del ${(d.roi * 100).toFixed(0)}%. Sin embargo, el período de recuperación de ${d.paybackPeriod} meses sugiere que la recuperación del capital tomará más de un año. Si bien la inversión es segura, su rentabilidad no es inmediata.\n\n`;
            analysis += `RECOMENDACIÓN: La inversión es aconsejable, pero con un enfoque estratégico en acelerar el retorno. Nuestra sugerencia es utilizar activamente la integración con Zoho CRM desde el primer día para lanzar campañas de marketing dirigidas (up-selling, cross-selling, programas de fidelización) que incrementen el Valor de Vida del Cliente (LTV). Un ligero aumento en el LTV podría reducir drásticamente el período de recuperación y maximizar el ROI final.`;
        } else {
            analysis += `Bajo los parámetros actuales, la inversión no alcanza la rentabilidad en el horizonte de 36 meses, resultando en un ROI negativo. El Costo Total de Propiedad (${formatCurrency(d.tco)}) supera los ingresos generados (${formatCurrency(d.totalRevenue)}).\n\n`;
            analysis += `RECOMENDACIÓN: No proceder con la inversión en este momento. Es crucial revaluar las variables de negocio. Recomendamos un análisis interno para determinar si el Valor de Vida del Cliente (LTV) de ${formatCurrency(d.customerLTV)} está subestimado. La propia implementación de Ohmyfi + Zoho CRM está diseñada para aumentar este LTV, pero es fundamental partir de un escenario base que, al menos, se acerque al punto de equilibrio. Sugerimos realizar una nueva simulación si se identifican oportunidades para mejorar el LTV.`;
        }
        
        if (d.financingTerm > 0) {
            analysis += `\n\nNOTA SOBRE FINANCIAMIENTO: La elección de un plazo de financiamiento de ${d.financingTerm} meses es una decisión financieramente inteligente, ya que protege el flujo de caja de la empresa al eliminar el desembolso inicial de ${formatCurrency(d.capex)}. Esto hace que el proyecto sea viable desde el primer día sin comprometer la liquidez.`;
        }
        return analysis;
    }

    function generateReportHTML(d) {
        const dataText = generateDataSummary(d);
        const analysisText = generateConsultantAnalysis(d).replace(/\n/g, '<br>');
        return `<pre class="text-sm text-slate-300 whitespace-pre-wrap font-mono">${dataText}</pre><div class="mt-6 pt-6 border-t border-slate-700 text-slate-300 font-sans">${analysisText}</div>`;
    }
    
    function generateDataSummary(d) {
        const scenarioText = d.scenario === 'completa' ? 'Solución Completa (AGT)' : 'Infraestructura Propia (BYOD)';
        let financingText = '';
        if (d.financingTerm > 0) {
            financingText = `
DETALLES DEL FINANCIAMIENTO:
---------------------------
- Plazo: ${d.financingTerm} cuotas mensuales de ${formatCurrency(d.monthlyFinancingPayment)}`;
        }

        return `INFORME DE ANÁLISIS FINANCIERO - SOLUCIÓN AGT OHMYFI
=====================================================
Fecha: ${new Date().toLocaleDateString('es-VE')}
Escenario: ${scenarioText}

PARÁMETROS DE ENTRADA:
----------------------
- Infraestructura: ${d.totalAps} APs (${d.apsIndoor} Interiores, ${d.apsOutdoor} Exteriores)
- Valor de Vida del Cliente (LTV): ${formatCurrency(d.customerLTV)}
- Costo Mensual de Internet: ${formatCurrency(d.internetCost)}
${d.scenario === 'completa' ? `- Plazo de Financiamiento: ${d.financingTerm} meses` : ''}

RESULTADOS PROYECTADOS A 3 AÑOS:
--------------------------------
- Inversión Inicial (CAPEX): ${formatCurrency(d.capex)}
- Costos Operativos (OPEX): ${formatCurrency(d.totalOpex)}
- Costo de Financiamiento: ${formatCurrency(d.financingCost)}
- COSTO TOTAL (TCO): ${formatCurrency(d.tco)}
- INGRESOS TOTALES: ${formatCurrency(d.totalRevenue)}
- BENEFICIO NETO: ${formatCurrency(d.netBenefit)}

INDICADORES CLAVE (KPI):
------------------------
- RETORNO DE LA INVERSIÓN (ROI): ${(d.roi * 100).toFixed(0)}%
- PERÍODO DE RECUPERACIÓN (PAYBACK): ${d.paybackPeriod > 0 ? `${d.paybackPeriod} meses` : 'No se recupera en 36 meses'}${financingText}`;
    }

    function downloadPDF(d) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ orientation: "p", unit: "mm", format: "a4" });
        const dataSummary = generateDataSummary(d);
        const consultantAnalysis = generateConsultantAnalysis(d);
        
        const margin = 15;
        const pageWidth = doc.internal.pageSize.getWidth();
        const textWidth = pageWidth - (margin * 2);
        let y = 20;

        doc.setFontSize(18);
        doc.setFont(undefined, 'bold');
        doc.text("Informe de Simulación Financiera", pageWidth / 2, y, { align: 'center' });
        y += 10;
        
        doc.setFontSize(12);
        doc.setFont(undefined, 'normal');
        doc.text("Solución OhmyFi + Zoho CRM por AGT", pageWidth / 2, y, { align: 'center' });
        y += 15;

        doc.setFont('courier', 'normal');
        doc.setFontSize(9);
        doc.text(dataSummary, margin, y);
        
        const dataLines = doc.splitTextToSize(dataSummary, textWidth).length;
        y += (dataLines * 3.5); // Approximate height
        
        y += 10;
        
        doc.setFont('helvetica', 'normal');
        doc.setFontSize(10);
        const analysisLines = doc.splitTextToSize(consultantAnalysis, textWidth);

        if (y + (analysisLines.length * 5) > 280) { // Check if new page is needed
            doc.addPage();
            y = 20;
        }
        
        doc.text(analysisLines, margin, y);
        
        doc.save(`Reporte_Consultoria_OhmyFi_${d.scenario}_${new Date().toISOString().slice(0,10)}.pdf`);
    }


    window.onload = initialize;
</script>
</body>
</html>

